<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ORBIT | Group SUCCESS</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            touch-action: manipulation;
        }

        input,
        select,
        button {
            font-size: 16px !important;
            touch-action: manipulation;
        }

        .chat-bg {
            background-color: #efeae2;
            background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png");
            background-size: 400px;
        }

        @media (max-width: 767px) {
            #sidebar {
                position: absolute;
                width: 100%;
                height: 100%;
                z-index: 20;
                transition: transform 0.3s ease;
            }

            #chat-main {
                position: absolute;
                width: 100%;
                height: 100%;
                z-index: 30;
                transform: translateX(100%);
                transition: transform 0.3s ease;
            }

            .mobile-chat-open #chat-main {
                transform: translateX(0);
            }

            .mobile-chat-open #sidebar {
                transform: translateX(-100%);
            }
        }

        .bubble-shadow {
            box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.15);
        }

        .emotion-emoji {
            font-size: 1.25rem;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
        }

        /* Audio Visualizer */
        .audio-visualizer.active {
            display: flex !important;
        }

        .audio-bar {
            width: 4px;
            background: #008069;
            border-radius: 99px;
            animation: visualize 1.2s infinite ease-in-out;
            height: 10px;
        }

        @keyframes visualize {

            0%,
            100% {
                height: 8px;
                opacity: 0.5;
            }

            50% {
                height: 20px;
                opacity: 1;
            }
        }

        .audio-bar:nth-child(1) {
            animation-delay: 0s;
        }

        .audio-bar:nth-child(2) {
            animation-delay: 0.1s;
        }

        .audio-bar:nth-child(3) {
            animation-delay: 0.2s;
        }

        .audio-bar:nth-child(4) {
            animation-delay: 0.3s;
        }

        .audio-bar:nth-child(5) {
            animation-delay: 0.4s;
        }
    </style>
</head>

<body class="flex items-center justify-center">

    <!-- GATEWAY MODAL -->
    <div id="gateway-modal"
        class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-md flex items-center justify-center p-4">
        <div
            class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-300">
            <div class="bg-[#008069] p-6 text-white text-center">
                <h2 class="text-xl font-bold">Succes Class</h2>
                <p class="text-xs opacity-80 uppercase tracking-widest mt-1">Join Conversation</p>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Display Name</label>
                    <input id="user-display-name" type="text" placeholder="Enter name" maxlength="20"
                        class="w-full border-2 border-gray-100 rounded-xl px-4 py-2 focus:border-[#008069] outline-none">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Room Code</label>
                    <input id="room-code" type="text" value="" placeholder="SUCCESS"
                        class="w-full border-2 border-gray-100 rounded-xl px-4 py-2 text-center text-xl font-bold focus:border-[#008069] outline-none uppercase tracking-widest">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Gender</label>
                        <select id="user-gender"
                            class="w-full border-2 border-gray-100 rounded-lg px-3 py-2 outline-none focus:border-[#008069] bg-white text-sm">
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Language</label>
                        <select id="user-lang"
                            class="w-full border-2 border-gray-100 rounded-lg px-3 py-2 outline-none focus:border-[#008069] bg-white text-sm"></select>
                    </div>
                </div>
                <button id="btn-connect"
                    class="w-full bg-[#00a884] text-white font-bold py-4 rounded-xl shadow-lg hover:bg-[#008069] transition-all uppercase tracking-widest mt-2">Start
                    Session</button>

                <button id="btn-install"
                    class="hidden w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-blue-700 transition-all uppercase tracking-widest mt-2">
                    <i class="fa-solid fa-download mr-2"></i> Install App
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN INTERFACE -->
    <div id="app-container"
        class="flex h-full w-full max-w-[1600px] bg-white overflow-hidden relative opacity-0 transition-opacity duration-500">
        <aside id="sidebar" class="w-[350px] border-r border-gray-200 bg-white flex flex-col shrink-0">
            <div class="h-[64px] bg-[#008069] flex items-center justify-between px-4 text-white shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-teal-900 flex items-center justify-center font-bold">GE</div>
                </div>
                <div class="flex gap-5 items-center opacity-70">
                    <button id="logout-btn" title="Logout" class="hover:text-red-400 transition-colors"><i
                            class="fa-solid fa-right-from-bracket"></i></button>
                    <i class="fa-solid fa-message"></i>
                </div>
            </div>
            <div id="chat-list" class="flex-1 overflow-y-auto">
                <div class="flex items-center gap-3 p-3 bg-gray-100 border-b border-gray-100">
                    <div id="sidebar-avatar"
                        class="w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-lg shrink-0">
                        SU</div>
                    <div class="flex-1">
                        <h3 id="sidebar-room-name" class="font-semibold text-gray-800 text-sm">SUCCESS</h3>
                        <p
                            class="text-[12px] text-teal-600 font-medium animate-pulse italic uppercase tracking-tighter">
                            Parallel Audio & Emotion Fixed</p>
                    </div>
                </div>
            </div>
        </aside>

        <main id="chat-main" class="flex-1 flex flex-col bg-[#efeae2] relative shadow-2xl">
            <header
                class="bg-[#f0f2f5] h-[64px] flex items-center justify-between px-4 border-b border-gray-200 shrink-0 z-20">
                <div class="flex items-center gap-3">
                    <button onclick="document.body.classList.remove('mobile-chat-open')"
                        class="md:hidden text-gray-500 p-2 -ml-2" title="Back"><i
                            class="fa-solid fa-arrow-left"></i></button>
                    <div id="header-avatar"
                        class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold shadow-sm">
                        SU</div>
                    <div>
                        <h2 id="room-header-name" class="font-semibold text-gray-800 text-[15px] leading-tight">SUCCESS
                        </h2>
                        <span id="user-display-meta"
                            class="text-[9px] text-gray-400 font-bold uppercase tracking-tight">Connecting...</span>
                    </div>
                </div>
                <div class="flex gap-6 items-center">
                    <button id="tts-toggle-btn"
                        class="text-gray-400 hover:text-[#008069] transition-colors p-2 text-xl"><i id="tts-icon"
                            class="fa-solid fa-volume-xmark"></i></button>
                    <button id="share-link-btn" class="text-gray-400 hover:text-blue-500 transition-colors p-2 text-xl"
                        title="Share Link"><i class="fa-solid fa-share-nodes"></i></button>
                    <button id="clear-chat-btn" class="text-gray-400 hover:text-red-500 transition-colors p-2 text-xl"
                        title="Clear Chat"><i class="fa-solid fa-trash"></i></button>
                </div>
            </header>

            <div id="msg-stream" class="flex-1 overflow-y-auto p-4 md:p-8 chat-bg flex flex-col gap-3"></div>

            <div class="bg-[#f0f2f5] p-2 md:p-3 flex items-center gap-2 border-t border-gray-200 relative z-40">
                <div
                    class="flex w-full items-center gap-3 bg-white rounded-full px-4 py-2 shadow-sm relative overflow-hidden">
                    <button id="raise-hand-btn" class="text-yellow-500 hover:text-yellow-600 transition-colors"><i
                            class="fa-solid fa-hand"></i></button>
                    <input id="text-input" type="text" placeholder="Type a message"
                        class="flex-1 outline-none text-[15px] bg-transparent z-10 relative">

                    <!-- VISUALIZER OVERLAY -->
                    <div id="audio-visualizer"
                        class="audio-visualizer absolute inset-0 bg-gray-100/90 z-20 hidden items-center justify-center gap-1">
                        <div class="audio-bar"></div>
                        <div class="audio-bar"></div>
                        <div class="audio-bar"></div>
                        <div class="audio-bar"></div>
                        <div class="audio-bar"></div>
                    </div>

                    <button id="send-btn" class="hidden text-teal-600 p-1 z-30"><i
                            class="fa-solid fa-paper-plane text-xl"></i></button>
                    <button id="dictate-btn" class="text-purple-600 p-1 z-30 mx-1 hover:scale-110 transition-transform"
                        title="Dictate & Send">
                        <svg class="w-6 h-6 fill-current" viewBox="0 0 24 24">
                            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z" />
                            <path
                                d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z" />
                        </svg>
                    </button>
                    <button id="mic-btn" class="text-gray-500 p-1 z-30 hover:scale-110 transition-transform"
                        title="Live Stream">
                        <svg class="w-6 h-6 stroke-current fill-none" viewBox="0 0 24 24" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 3v18" />
                            <path d="M8 8v8" />
                            <path d="M4 11v2" />
                            <path d="M16 8v8" />
                            <path d="M20 11v2" />
                        </svg>
                    </button>
                </div>
                <div id="voice-overlay" class="absolute inset-0 bg-[#f0f2f5] z-50 flex items-center px-4 hidden">
                    <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse mr-3"></div>
                    <span id="timer" class="font-mono text-xs text-gray-500 w-10">00:00</span>
                    <div class="flex-1 h-8 flex items-center overflow-hidden mx-2"><canvas id="viz" height="30"
                            class="w-full"></canvas></div>
                    <button id="cancel-voice" class="p-2 text-gray-400 hover:text-red-500"><i
                            class="fa-solid fa-trash"></i></button>
                    <button id="stop-voice"
                        class="w-10 h-10 bg-[#00a884] text-white rounded-full flex items-center justify-center shadow-lg"><i
                            class="fa-solid fa-check"></i></button>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onChildAdded, onChildRemoved, onValue, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { createClient, LiveTranscriptionEvents } from 'https://cdn.jsdelivr.net/npm/@deepgram/sdk@3/+esm';

        // --- KEYS & CONFIG ---
        const CARTESIA_API_KEY = "sk_car_yWEX9Mp2LwKju8FXyosGhj";
        const CARTESIA_VOICES = { "Male": "aa3fdf22-9f5e-4238-8016-31f515ded9a3", "Female": "cbaf8084-f009-4838-a096-07ee2e6612b1" };
        const DEEPGRAM_KEY = '11ee938d032ce7c36c6fa82338274be5e4ada847';
        const firebaseConfig = {
            apiKey: "AIzaSyC93B2GgE3HzaWl5gW_mRroobQybaZNFJs",
            authDomain: "macx-5feca.firebaseapp.com",
            databaseURL: "https://macx-5feca-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "macx-5feca",
            storageBucket: "macx-5feca.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef1234567890abcdef"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const langList = ["Abkhaz", "Acehnese", "Acholi", "Afar", "Afrikaans", "Albanian", "Alur", "Amharic", "Arabic", "Armenian", "Assamese", "Avar", "Awadhi", "Aymara", "Azerbaijani", "Balinese", "Baluchi", "Bambara", "Baoul√©", "Bashkir", "Basque", "Batak Karo", "Batak Simalungun", "Batak Toba", "Belarusian", "Bemba", "Bengali", "Betawi", "Bhojpuri", "Bikol", "Bosnian", "Breton", "Bulgarian", "Buryat", "Cantonese", "Catalan", "Cebuano", "Chamorro", "Chechen", "Chichewa", "Chinese (Simplified)", "Chinese (Traditional)", "Chuukese", "Chuvash", "Corsican", "Crimean Tatar (Cyrillic)", "Crimean Tatar (Latin)", "Croatian", "Czech", "Danish", "Dari", "Dhivehi", "Dinka", "Dogri", "Dombe", "Dutch", "Dyula", "Dzongkha", "English", "Esperanto", "Estonian", "Ewe", "Faroese", "Fijian", "Filipino", "Finnish", "Fon", "French", "French (Canada)", "Frisian", "Friulian", "Fulani", "Ga", "Galician", "Georgian", "German", "Greek", "Guarani", "Gujarati", "Haitian Creole", "Hakha Chin", "Hausa", "Hawaiian", "Hebrew", "Hiligaynon", "Hindi", "Hmong", "Hungarian", "Hunsrik", "Iban", "Icelandic", "Igbo", "Ilocano", "Indonesian", "Inuktut (Latin)", "Inuktut (Syllabics)", "Irish", "Italian", "Jamaican Patois", "Japanese", "Javanese", "Jingpo", "Kalaallisut", "Kannada", "Kanuri", "Kapampangan", "Kazakh", "Khasi", "Khmer", "Kiga", "Kikongo", "Kinyarwanda", "Kituba", "Kokborok", "Komi", "Konkani", "Korean", "Krio", "Kurdish (Kurmanji)", "Kurdish (Sorani)", "Kyrgyz", "Lao", "Latgalian", "Latin", "Latvian", "Ligurian", "Limburgish", "Lingala", "Lithuanian", "Lombard", "Luganda", "Luo", "Luxembourgish", "Macedonian", "Madurese", "Maithili", "Makassar", "Malagasy", "Malay", "Malay (Jawi)", "Malayalam", "Maltese", "Mam", "Manx", "Maori", "Marathi", "Marshallese", "Marwadi", "Mauritian Creole", "Meadow Mari", "Meiteilon (Manipuri)", "Minang", "Mizo", "Mongolian", "Myanmar (Burmese)", "Nahuatl (Eastern Huasteca)", "Ndau", "Ndebele (South)", "Nepalbhasa (Newari)", "Nepali", "NKo", "Norwegian", "Nuer", "Occitan", "Odia (Oriya)", "Oromo", "Ossetian", "Pangasinan", "Papiamento", "Pashto", "Persian", "Polish", "Portuguese (Brazil)", "Portuguese (Portugal)", "Punjabi (Gurmukhi)", "Punjabi (Shahmukhi)", "Quechua", "Q ºeqchi º", "Romani", "Romanian", "Rundi", "Russian", "Sami (North)", "Samoan", "Sango", "Sanskrit", "Santali (Latin)", "Santali (Ol Chiki)", "Scots Gaelic", "Sepedi", "Serbian", "Sesotho", "Seychellois Creole", "Shan", "Shona", "Sicilian", "Silesian", "Sindhi", "Sinhala", "Slovak", "Slovenian", "Somali", "check", "Spanish", "Sundanese", "Susu", "Swahili", "Swati", "Swedish", "Tahitian", "Tajik", "Tamazight", "Tamazight (Tifinagh)", "Tamil", "Tatar", "Telugu", "Tetum", "Thai", "Tibetan", "Tigrinya", "Tiv", "Tok Pisin", "Tongan", "Tshiluba", "Tsonga", "Tswana", "Tulu", "Tumbuka", "Turkish", "Turkmen", "Tuvan", "Twi", "Udmurt", "Ukrainian", "Urdu", "Uyghur", "Uzbek", "Venda", "Venetian", "Vietnamese", "Waray", "Welsh", "Wolof", "Xhosa", "Yakut", "Yiddish", "Yoruba", "Yucatec Maya", "Zapotec", "Zulu"];
        const EMOTIONS = { "neutral": "üòê", "angry": "üò†", "excited": "ü§©", "content": "üòä", "sad": "üò¢", "scared": "üò®", "happy": "üòÄ", "apologetic": "üôá", "curious": "ü§î", "amazed": "üò≤", "triumphant": "üèÜ", "bored": "üò¥", "tired": "ü•±", "confused": "üòµ‚Äçüí´", "determined": "‚úä", "proud": "ü¶Å", "nervous": "üò¨" };

        let myUserId = `user-${Math.floor(Math.random() * 99999)}`;
        let userData = { name: '', room: 'SUCCESS', gender: 'Male', language: 'nl', joined: false };
        let isRec = false, mediaRec, dgSocket, aCtx, aFr, tStart, tInt, activeSegmentRef = null;
        let ttsEnabled = false, joinTimestamp = null;
        const audioQueue = [];
        let isAudioPlaying = false;

        const ui = {
            modal: document.getElementById('gateway-modal'), app: document.getElementById('app-container'), langSelect: document.getElementById('user-lang'), msgWin: document.getElementById('msg-stream'), txtIn: document.getElementById('text-input'), sendBtn: document.getElementById('send-btn'), micBtn: document.getElementById('mic-btn'), voiceOver: document.getElementById('voice-overlay'), timer: document.getElementById('timer'), viz: document.getElementById('viz'), ttsBtn: document.getElementById('tts-toggle-btn'), ttsIcon: document.getElementById('tts-icon'), logout: document.getElementById('logout-btn')
        };

        // --- SESSION PERSISTENCE ---
        function saveSession() {
            // Update userData from inputs if they are available (for auto-saving before join)
            if (!userData.joined) {
                const nameIn = document.getElementById('user-display-name');
                const roomIn = document.getElementById('room-code');
                const genderIn = document.getElementById('user-gender');

                if (nameIn) userData.name = nameIn.value;
                if (roomIn) userData.room = roomIn.value.toUpperCase();
                if (genderIn) userData.gender = genderIn.value;
                if (ui.langSelect) userData.language = ui.langSelect.value;
            }
            localStorage.setItem('orbit_session', JSON.stringify({ ...userData, joinTime: joinTimestamp }));
        }

        function loadSession() {
            const saved = localStorage.getItem('orbit_session');
            if (saved) {
                const data = JSON.parse(saved);
                userData = { ...data }; // Restore all data including joined status

                // Restore Form Values
                if (data.language && ui.langSelect) ui.langSelect.value = data.language;
                if (data.name && document.getElementById('user-display-name')) document.getElementById('user-display-name').value = data.name;
                if (data.room && document.getElementById('room-code')) document.getElementById('room-code').value = data.room;
                if (data.gender && document.getElementById('user-gender')) document.getElementById('user-gender').value = data.gender;

                joinTimestamp = data.joinTime;

                // Only auto-join if they actually joined previously
                if (data.joined) {
                    connectToApp(true);
                }
            }
        }
        function clearSession() { localStorage.removeItem('orbit_session'); location.reload(); }

        // --- AUDIO QUEUE SYSTEM ---
        async function processAudioQueue() {
            if (isAudioPlaying || audioQueue.length === 0) return;
            isAudioPlaying = true;
            const item = audioQueue.shift();
            try {
                const voiceId = CARTESIA_VOICES[item.gender] || CARTESIA_VOICES["Male"];
                const transcript = `<emotion value="${item.emotion || 'neutral'}" />${item.text}`;
                const response = await fetch("https://api.cartesia.ai/tts/bytes", {
                    method: "POST",
                    headers: { "Cartesia-Version": "2025-04-16", "X-API-Key": CARTESIA_API_KEY, "Content-Type": "application/json" },
                    body: JSON.stringify({ "model_id": "sonic-3-latest", "transcript": transcript, "voice": { "mode": "id", "id": voiceId }, "output_format": { "container": "wav", "encoding": "pcm_f32le", "sample_rate": 44100 }, "speed": "normal", "generation_config": { "speed": 1, "volume": 1, "emotion": item.emotion || "neutral" } })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const audio = new Audio(url);

                    if ('mediaSession' in navigator) {
                        navigator.mediaSession.metadata = new MediaMetadata({
                            title: `Message from ${item.gender}`,
                            artist: 'ORBIT TTS',
                            album: 'Live Chat',
                            artwork: [{ src: 'icon.png', sizes: '512x512', type: 'image/png' }]
                        });
                        navigator.mediaSession.playbackState = 'playing';
                    }

                    const finish = () => {
                        isAudioPlaying = false;
                        if ('mediaSession' in navigator) navigator.mediaSession.playbackState = 'none';
                        processAudioQueue();
                    };

                    audio.onended = finish;
                    audio.onerror = (e) => { console.error("TTS Error", e); finish(); };

                    try {
                        await audio.play();
                    } catch (playErr) {
                        console.error("Autoplay prevented", playErr);
                        finish();
                    }
                } else {
                    console.error("TTS API Error");
                    isAudioPlaying = false;
                    processAudioQueue();
                }
            } catch (e) {
                console.error("TTS Fetch Error", e);
                isAudioPlaying = false;
                processAudioQueue();
            }
        }

        async function translate(text, from, to) {
            if (from === to) return text;
            try {
                const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=${from}&tl=${to}&dt=t&q=${encodeURI(text)}`);
                const data = await res.json();
                return data[0][0][0];
            } catch (e) { return text; }
        }

        function init() {
            langList.forEach(l => {
                const opt = document.createElement('option');
                const codeMap = { "Dutch": "nl", "Filipino": "tl", "Tagalog": "tl", "English": "en", "Spanish": "es", "French": "fr", "German": "de" };
                opt.value = codeMap[l] || "en";
                opt.text = l === "Dutch" ? "Dutch Flemish" : l;
                if (l === "Dutch") opt.selected = true;
                ui.langSelect.add(opt);
            });
        }

        function connectToApp(isAuto = false) {
            if (!isAuto) {
                const nameInput = document.getElementById('user-display-name').value.trim();
                const roomInput = document.getElementById('room-code').value.trim().toUpperCase();
                if (!nameInput) return alert("Enter Display Name");
                userData.name = nameInput.substring(0, 8);
                userData.room = roomInput || 'SUCCESS';
                userData.gender = document.getElementById('user-gender').value;
                userData.language = ui.langSelect.value;
                userData.joined = true;
                joinTimestamp = Date.now();
                saveSession();
            }
            ui.modal.classList.add('hidden');
            ui.app.classList.remove('opacity-0');
            document.getElementById('room-header-name').innerText = userData.room;
            document.getElementById('sidebar-room-name').innerText = userData.room;
            document.getElementById('user-display-meta').innerText = `${userData.name} ‚Ä¢ ${userData.gender} ‚Ä¢ ${userData.language.toUpperCase()}`;
            document.body.classList.add('mobile-chat-open');

            // Presence Logic
            const userRef = ref(db, `chats/${userData.room}/users/${myUserId}`);
            set(userRef, { name: userData.name, gender: userData.gender, id: myUserId, lang: userData.language, status: 'online' });
            onDisconnect(userRef).remove();

            // Setup Sidebar & Chat
            setupSidebarAndChat();
        }

        let currentChatId = null;
        function setupSidebarAndChat() {
            // Render Group Item (Always Top)
            const list = document.getElementById('chat-list');
            list.innerHTML = `
                <div onclick="switchChat('${userData.room}', '${userData.room}', true)" class="flex items-center gap-3 p-3 bg-gray-100 hover:bg-gray-200 cursor-pointer border-b border-gray-200 chat-item" data-id="${userData.room}">
                    <div class="w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-lg shrink-0">GP</div>
                    <div class="flex-1"><h3 class="font-semibold text-gray-800 text-sm">${userData.room}</h3><p class="text-[12px] text-teal-600 font-medium">Group Chat</p></div>
                </div>
            `;

            // Listen for other users
            onValue(ref(db, `chats/${userData.room}/users`), (snap) => {
                // Clear existing users but keep Group at top? 
                // Simpler: re-render list starting with Group
                list.innerHTML = `
                    <div onclick="switchChat('${userData.room}', '${userData.room}', true)" class="flex items-center gap-3 p-3 ${currentChatId === userData.room ? 'bg-gray-100' : 'bg-white'} hover:bg-gray-200 cursor-pointer border-b border-gray-200 chat-item" data-id="${userData.room}">
                        <div class="w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-lg shrink-0">GP</div>
                        <div class="flex-1"><h3 class="font-semibold text-gray-800 text-sm">${userData.room}</h3><p class="text-[12px] text-teal-600 font-medium">Group Chat</p></div>
                    </div>
                `;

                if (snap.val()) {
                    Object.values(snap.val()).forEach(u => {
                        if (u.id === myUserId) return; // Don't show self
                        const div = document.createElement('div');
                        div.className = `flex items-center gap-3 p-3 ${currentChatId && currentChatId.includes(u.id) ? 'bg-gray-100' : 'bg-white'} hover:bg-gray-200 cursor-pointer border-b border-gray-200 chat-item`;
                        div.dataset.id = u.id;
                        div.onclick = () => switchChat(u.id, u.name, false);
                        div.innerHTML = `
                            <div class="w-12 h-12 rounded-full bg-indigo-500 text-white flex items-center justify-center font-bold text-lg shrink-0">${u.name.substring(0, 2).toUpperCase()}</div>
                            <div class="flex-1"><h3 class="font-semibold text-gray-800 text-sm">${u.name}</h3><p class="text-[12px] text-gray-500 font-medium">Online</p></div>
                        `;
                        list.appendChild(div);
                    });
                }
            });

            // Start in Group
            switchChat(userData.room, userData.room, true);
        }

        window.switchChat = function (targetId, name, isGroup) {
            currentChatId = isGroup ? targetId : [myUserId, targetId].sort().join('_');

            // Update UI Active State
            document.querySelectorAll('.chat-item').forEach(el => {
                if (el.dataset.id === targetId || (isGroup && el.dataset.id === userData.room)) el.classList.add('bg-gray-100');
                else el.classList.remove('bg-gray-100');
            });

            document.getElementById('room-header-name').innerText = name;
            document.getElementById('header-avatar').innerText = name.substring(0, 2).toUpperCase();

            // Bind Firebase
            bindFirebase(currentChatId);

            // On mobile close sidebar
            document.body.classList.add('mobile-chat-open');
        }

        function getEmotion(text) {
            const l = text.toLowerCase();
            if (l.includes("sorry")) return "apologetic";
            if (l.includes("wow")) return "amazed";
            if (l.includes("angry")) return "angry";
            if (l.includes("happy")) return "happy";
            return "neutral";
        }

        function pushMsg(text, isFinal = true) {
            const emotion = isFinal ? getEmotion(text) : "neutral";
            const emoji = EMOTIONS[emotion] || "üòê";

            const path = isFinal ? `chats/${currentChatId}/messages` : `chats/${currentChatId}/drafts`;
            const targetRef = isFinal ? push(ref(db, path)) : (activeSegmentRef || push(ref(db, path)));
            if (!isFinal) activeSegmentRef = targetRef;

            set(targetRef, {
                text, senderId: myUserId, senderName: userData.name, gender: userData.gender, lang: userData.language,
                emotion, emoji, timestamp: Date.now()
            });

            if (isFinal && activeSegmentRef) { remove(activeSegmentRef); activeSegmentRef = null; }
        }

        let unsubMsg = null;
        let unsubRemoved = null;

        function bindFirebase(chatId) {
            ui.msgWin.innerHTML = '';
            if (unsubMsg) { unsubMsg(); unsubMsg = null; }
            if (unsubRemoved) { unsubRemoved(); unsubRemoved = null; }

            const messagesRef = ref(db, `chats/${chatId}/messages`);
            const draftsRef = ref(db, `chats/${chatId}/drafts`);

            unsubMsg = onChildAdded(messagesRef, async (snap) => {
                const msg = snap.val();
                if (!msg) return;
                msg.id = snap.key;

                if (msg.senderId !== myUserId && msg.timestamp >= joinTimestamp) {
                    msg.translatedText = await translate(msg.text, msg.lang, userData.language);
                    audioQueue.push({ text: msg.translatedText, gender: msg.gender, emotion: msg.emotion });
                    if (ttsEnabled) processAudioQueue();
                }
                renderBubble(msg);
            });

            // Listen for removals
            unsubRemoved = onChildRemoved(messagesRef, (snap) => {
                const el = document.getElementById(`msg-${snap.key}`);
                if (el) el.remove();
            });

            onValue(draftsRef, (snap) => {
                document.querySelectorAll('.is-live').forEach(el => el.remove());
                if (snap.val()) Object.entries(snap.val()).forEach(([key, val]) => renderBubble(val, true));
            });
        }

        function renderBubble(msg, isLive = false) {
            const isMe = msg.senderId === myUserId;
            // Deduplicate
            if (msg.id && document.getElementById(`msg-${msg.id}`)) return;

            const div = document.createElement('div');
            div.className = `flex ${isMe ? 'justify-end' : 'justify-start'} ${isLive ? 'is-live opacity-50' : ''}`;
            if (msg.id) div.id = `msg-${msg.id}`;

            const content = (!isMe && msg.translatedText) ? `${msg.translatedText}` : msg.text;
            div.innerHTML = `<div class="${isMe ? 'bg-[#d9fdd3] rounded-tr-none' : 'bg-white rounded-tl-none'} p-2 rounded-lg bubble-shadow max-w-[85%] flex items-end gap-2"><div class="flex-1"><p class="text-[14.5px] text-[#111b21] leading-tight pr-1 pb-1">${content}</p><div class="flex items-center gap-1"><span class="text-[8px] text-gray-400 font-bold uppercase tracking-tighter">${msg.senderName} ‚Ä¢ ${msg.gender} ‚Ä¢ ${msg.lang}</span></div></div><div class="emotion-emoji shrink-0">${msg.emoji || 'üòê'}</div></div>`;
            ui.msgWin.appendChild(div);
            ui.msgWin.scrollTop = ui.msgWin.scrollHeight;
        }

        // --- FIXED DEEPGRAM (NO WORDS MISSED) ---
        // --- AUDIO MODES ---
        let recMode = null; // 'stream' or 'dictate'
        let dictationBuffer = "";
        let lastInterim = ""; // Fallback if no final result

        async function startVoice(mode = 'stream') {
            try {
                // Toggle Logic: If actively recording in same mode...
                if (isRec && recMode === mode) {
                    // If Dictate -> Save/Send. If Stream -> Just Stop.
                    stopVoice(mode === 'dictate');
                    return;
                }
                if (isRec) stopVoice(false); // Switching modes -> Cancel previous

                recMode = mode;
                dictationBuffer = "";

                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                isRec = true;

                // UI: Show visualizer for Stream, or just active state for Dictate
                if (mode === 'stream') {
                    ui.voiceOver.classList.remove('hidden');
                    setupViz(stream);
                } else {
                    // Dictate mode: maybe different UI? For now using input visualizer but allowing typing?
                    // User said: "allow current user to just type ... if he dont want to speak at the streaming"
                    // But for dictate, we probably want to visualize audio too.
                    document.getElementById('audio-visualizer').classList.add('active');
                }

                // Lock input only for Stream
                if (mode === 'stream') {
                    document.getElementById('audio-visualizer').classList.add('active');
                    ui.txtIn.disabled = true;
                    ui.txtIn.placeholder = "Streaming... (Typing Disabled)";
                } else {
                    ui.txtIn.placeholder = "Dictating... (Processing logic on stop)";
                }

                tStart = Date.now();
                if (mode === 'stream') {
                    tInt = setInterval(() => { const s = Math.floor((Date.now() - tStart) / 1000); ui.timer.innerText = `${Math.floor(s / 60).toString().padStart(2, '0')}:${(s % 60).toString().padStart(2, '0')}`; }, 1000);
                }

                // Wake Lock for Stream
                if (mode === 'stream' && 'wakeLock' in navigator) {
                    try { await navigator.wakeLock.request('screen'); } catch (err) { console.log('Wake Lock error:', err); }
                }

                // Wake Lock for Stream
                if (mode === 'stream' && 'wakeLock' in navigator) {
                    try { await navigator.wakeLock.request('screen'); } catch (err) { console.log('Wake Lock error:', err); }
                }

                const client = createClient(DEEPGRAM_KEY);
                dgSocket = client.listen.live({
                    model: "nova-3", language: userData.language, smart_format: true, interim_results: true,
                    endpointing: 500, vad_events: true, punctuate: true, utterance_end_ms: 2000
                });

                dgSocket.on(LiveTranscriptionEvents.Open, () => {
                    mediaRec = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                    mediaRec.ondataavailable = (e) => { if (e.data.size > 0 && dgSocket.getReadyState() === 1) dgSocket.send(e.data); };
                    mediaRec.start(250);
                });

                dgSocket.on(LiveTranscriptionEvents.Transcript, (data) => {
                    const txt = data.channel.alternatives[0].transcript;
                    if (!txt.trim()) return;

                    if (recMode === 'stream') {
                        // Stream: Send immediately
                        pushMsg(txt, data.is_final);
                    } else {
                        // Dictate: Accumulate final results
                        lastInterim = txt; // Always save latest
                        if (data.is_final) {
                            dictationBuffer += (dictationBuffer ? " " : "") + txt;
                            lastInterim = ""; // Clear interim since we have final
                        }
                    }
                });

                dgSocket.on(LiveTranscriptionEvents.Error, () => stopVoice(false));
            } catch (e) { console.error(e); stopVoice(false); }
        }

        async function stopVoice(save) {
            // Wait to let final transcript arrive before killing socket
            if (save && recMode === 'dictate') {
                const btn = document.getElementById('dictate-btn');
                const originalIcon = btn.innerHTML;
                // Show spinner
                btn.innerHTML = `<svg class="w-6 h-6 animate-spin fill-current" viewBox="0 0 24 24"><path d="M12 4V2A10 10 0 0 0 2 12h2a8 8 0 0 1 8-8z"/></svg>`;
                ui.txtIn.placeholder = "Transcribing... please wait";

                await new Promise(r => setTimeout(r, 1500)); // Increased to 1.5s

                // Use buffer OR fallback to last interim
                const finalMsg = dictationBuffer.trim() || lastInterim.trim();

                if (finalMsg) {
                    pushMsg(finalMsg, true);
                    showToast("Sent!");
                } else {
                    showToast("No speech detected.");
                }
                btn.innerHTML = originalIcon;
            }

            isRec = false; mediaRec?.stop(); dgSocket?.finish(); clearInterval(tInt);
            ui.voiceOver.classList.add('hidden'); ui.timer.innerText = "00:00";

            // Input Visualizer OFF
            document.getElementById('audio-visualizer').classList.remove('active');

            // Re-enable input
            ui.txtIn.disabled = false;
            ui.txtIn.placeholder = "Type a message";

            // Stream Mode Cleanup
            if (!save && activeSegmentRef) { remove(activeSegmentRef); activeSegmentRef = null; }

            recMode = null;
            dictationBuffer = "";
            lastInterim = "";
        }

        function setupViz(stream) {
            const vCtx = new AudioContext(); const aAn = vCtx.createAnalyser(); aAn.fftSize = 64; vCtx.createMediaStreamSource(stream).connect(aAn);
            const buf = new Uint8Array(aAn.frequencyBinCount), ctx = ui.viz.getContext('2d'); ui.viz.width = ui.viz.parentElement.offsetWidth;
            const draw = () => {
                if (!isRec) return vCtx.close(); aFr = requestAnimationFrame(draw); aAn.getByteFrequencyData(buf); ctx.clearRect(0, 0, ui.viz.width, ui.viz.height);
                let x = 0; const barW = (ui.viz.width / buf.length) * 2;
                for (let i = 0; i < buf.length; i++) { const h = (buf[i] / 255) * 30; ctx.fillStyle = '#00a884'; ctx.beginPath(); ctx.roundRect(x, (30 - h) / 2, barW - 3, h, 10); ctx.fill(); x += barW; }
            }; draw();
        }

        ui.txtIn.oninput = () => { ui.sendBtn.classList.toggle('hidden', ui.txtIn.value.trim() === ""); };
        ui.sendBtn.onclick = () => { if (ui.txtIn.value.trim()) { pushMsg(ui.txtIn.value.trim(), true); ui.txtIn.value = ''; ui.txtIn.oninput(); } };
        ui.micBtn.onclick = () => startVoice('stream');
        ui.logout.onclick = clearSession;
        document.getElementById('btn-connect').onclick = () => connectToApp(false);
        ui.ttsBtn.onclick = () => {
            ttsEnabled = !ttsEnabled;
            ui.ttsIcon.className = ttsEnabled ? "fa-solid fa-volume-high text-[#008069]" : "fa-solid fa-volume-xmark text-gray-400";
            if (ttsEnabled) processAudioQueue();
        };
        document.getElementById('stop-voice').onclick = () => stopVoice(true);
        document.getElementById('cancel-voice').onclick = () => stopVoice(false);
        document.getElementById('clear-chat-btn').onclick = () => {
            if (confirm(`Clear chat for ${currentChatId === userData.room ? 'Group' : 'this DM'}?`)) {
                const path = currentChatId === userData.room
                    ? `chats/${userData.room}/messages`
                    : `chats/${currentChatId}/messages`;
                remove(ref(db, path)).then(() => showToast("Chat cleared"));
            }
        };
        document.getElementById('share-link-btn').onclick = () => {
            // Copy current URL (or clean base URL)
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => showToast("Link copied to clipboard!"));
        };
        document.getElementById('raise-hand-btn').onclick = () => {
            pushMsg("raised hand", true);
            showToast("Hand raised!");
        };
        document.getElementById('dictate-btn').onclick = () => startVoice('dictate');


        function showToast(msg) {
            const t = document.createElement('div');
            t.className = 'fixed top-4 right-4 bg-black/80 text-white px-4 py-2 rounded-lg z-[100] animate-bounce';
            t.innerText = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 2000);
        }

        init();

        // Auto-save settings on change
        ['user-display-name', 'room-code', 'user-gender', 'user-lang'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('change', saveSession);
                el.addEventListener('input', saveSession);
            }
        });

        // PWA Install Logic
        let deferredPrompt;
        const installBtn = document.getElementById('btn-install');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Show install button if user hasn't joined or just generally in the gateway
            installBtn.classList.remove('hidden');
        });

        installBtn.addEventListener('click', async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to the install prompt: ${outcome}`);
            deferredPrompt = null;
            installBtn.classList.add('hidden');
        });

        window.addEventListener('appinstalled', () => {
            installBtn.classList.add('hidden');
            console.log('PWA was installed');
        });

        loadSession();

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('Service Worker Registered'))
                .catch(err => console.error('SW Registration Failed:', err));
        }
    </script>
</body>

</html>