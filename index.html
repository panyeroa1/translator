<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#3b82f6">
    <link rel="apple-touch-icon" href="pwa_icon.png">
    <link rel="manifest"
        href='data:application/json,{"name":"Succes Class","short_name":"Succes","start_url":"./","display":"standalone","background_color":"#ffffff","theme_color":"#3b82f6","icons":[{"src":"pwa_icon.png","sizes":"512x512","type":"image/png"}]}'>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Succes Class - Real-time Translation & Hybrid Learning</title>

    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Fonts: Inter (Premium, clean sans-serif) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9', // Sky Blue
                            600: '#0284c7',
                            900: '#0c4a6e',
                        },
                        accent: {
                            500: '#8b5cf6', // Violet
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* --- Premium Base Styles --- */
        :root {
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.5);
            --glass-blur: blur(12px);
            --shadow-soft: 0 10px 40px -10px rgba(0, 0, 0, 0.08);
            --shadow-hard: 0 20px 40px -10px rgba(0, 0, 0, 0.12);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f3f4f6 0%, #e0f2fe 100%);
            height: 100vh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            color: #1f2937;
        }

        /* Input Reset & Styling */
        .input-glass {
            background: rgba(255, 255, 255, 0.6);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.02);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .input-glass:focus {
            background: #ffffff;
            border-color: #0ea5e9;
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.15), inset 0 2px 4px rgba(0, 0, 0, 0.01);
            outline: none;
        }

        /* Buttons */
        .btn-modern {
            transition: transform 0.1s ease, box-shadow 0.2s ease, background 0.2s ease;
        }

        .btn-modern:active {
            transform: scale(0.97);
        }

        /* Scrollbar */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        /* Utilities */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-soft);
        }

        .message-bubble {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: transform 0.2s;
            transform-origin: bottom left;
        }

        .mic-active-ring {
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 15px rgba(239, 68, 68, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        /* Animations */
        .view-transition {
            transition: opacity 0.4s ease, transform 0.4s ease;
        }

        .view-hidden {
            opacity: 0;
            pointer-events: none;
            position: absolute;
            inset: 0;
            transform: scale(0.98);
            z-index: -1;
        }

        .view-active {
            opacity: 1;
            pointer-events: auto;
            position: relative;
            transform: scale(1);
            z-index: 10;
        }
    </style>
</head>

<body class="antialiased text-gray-800">

    <!-- Toast Container -->
    <div id="toast-container"
        class="fixed top-4 left-0 right-0 z-50 pointer-events-none flex flex-col items-center gap-2 p-4"></div>

    <!-- MAIN APP CONTAINER -->
    <main id="app"
        class="relative w-full h-full max-w-lg mx-auto bg-white/50 shadow-2xl overflow-hidden md:rounded-2xl md:my-8 md:h-[calc(100vh-4rem)] md:border md:border-white/50 backdrop-blur-3xl">

        <!-- ================= VIEW: LOGIN ================= -->
        <section id="view-login" class="view-active w-full h-full flex flex-col p-8 transition-all duration-500">
            <!-- Header/Logo -->
            <div class="flex-1 flex flex-col items-center justify-center space-y-6 animate-slide-up">
                <div class="relative w-28 h-28">
                    <!-- Icon per reference (red outline style) -->
                    <div class="relative w-full h-full flex items-center justify-center">
                        <i class="fa-solid fa-chalkboard-user text-6xl text-red-500/80 drop-shadow-sm"></i>
                        <div
                            class="absolute -right-2 -top-2 bg-red-50 text-red-500 text-[10px] font-bold px-1.5 py-0.5 rounded-md border border-red-100">
                            1.0</div>
                    </div>
                </div>
            </div>

            <!-- Login Form (Student) -->
            <div id="form-student" class="w-full space-y-5 mb-4 animate-slide-up" style="animation-delay: 0.1s;">
                <div class="group">
                    <label class="block text-sm font-semibold text-gray-500 mb-1.5 ml-1">Conversation Code</label>
                    <div class="relative flex gap-2">
                        <input id="login-code" type="text" placeholder="Enter conversation code"
                            class="input-glass flex-1 px-4 py-3.5 rounded-lg text-base font-medium text-gray-800 placeholder-gray-400 bg-gray-50/50 border-gray-200 focus:bg-white transition-all">
                        <div
                            class="w-12 flex items-center justify-center bg-gray-100 rounded-lg text-gray-500 text-2xl">
                            <i class="fa-solid fa-qrcode"></i>
                        </div>
                    </div>
                </div>

                <div class="group">
                    <label class="block text-sm font-semibold text-gray-500 mb-1.5 ml-1">Username</label>
                    <input id="login-name" type="text" placeholder="Enter Username"
                        class="input-glass w-full px-4 py-3.5 rounded-lg text-base font-medium text-gray-800 placeholder-gray-400 bg-gray-50/50 border-gray-200 focus:bg-white">
                </div>

                <div class="group">
                    <label class="block text-sm font-semibold text-gray-500 mb-1.5 ml-1">Receiving Language</label>
                    <div class="relative">
                        <select id="login-lang" title="Select your receiving language"
                            class="input-glass w-full px-4 py-3.5 rounded-lg text-base font-medium text-gray-800 appearance-none bg-gray-50/50 border-gray-200 focus:bg-white pr-10 truncate">
                            <!-- Populated dynamically -->
                        </select>
                        <i
                            class="fa-solid fa-caret-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                    </div>
                </div>

                <button onclick="App.handleLogin()" title="Join Conversation"
                    class="btn-modern w-full bg-[#0ea5e9] hover:bg-[#0284c7] text-white font-semibold py-3.5 rounded-lg shadow-lg shadow-blue-500/20 flex items-center justify-center gap-2 mt-4 text-lg">
                    <span>Join Conversation</span>
                </button>
            </div>

            <!-- Teacher Login Form (Hidden by default) -->
            <div id="form-teacher" class="hidden w-full space-y-5 mb-4 animate-slide-up">
                <div class="group">
                    <label class="block text-sm font-semibold text-gray-500 mb-1.5 ml-1"
                        for="teacher-email">Email</label>
                    <input id="teacher-email" type="email" value="teacher@adahconnect.com" placeholder="Email"
                        title="Teacher Email"
                        class="input-glass w-full px-4 py-3.5 rounded-lg text-base font-medium text-gray-800 placeholder-gray-400 bg-gray-50/50 border-gray-200 focus:bg-white">
                </div>
                <div class="group">
                    <label class="block text-sm font-semibold text-gray-500 mb-1.5 ml-1"
                        for="teacher-pw">Password</label>
                    <input id="teacher-pw" type="password" value="teacher456321" placeholder="Password"
                        title="Teacher Password"
                        class="input-glass w-full px-4 py-3.5 rounded-lg text-base font-medium text-gray-800 placeholder-gray-400 bg-gray-50/50 border-gray-200 focus:bg-white">
                </div>
                <div class="group">
                    <label class="block text-sm font-semibold text-gray-500 mb-1.5 ml-1">Language</label>
                    <div class="relative">
                        <select id="teacher-lang" title="Select your instruction language"
                            class="input-glass w-full px-4 py-3.5 rounded-lg text-base font-medium text-gray-800 appearance-none bg-gray-50/50 border-gray-200 focus:bg-white pr-10 truncate">
                            <!-- Populated dynamically -->
                        </select>
                        <i
                            class="fa-solid fa-caret-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                    </div>
                </div>

                <button onclick="App.handleTeacherLogin()" title="Login & Start"
                    class="btn-modern w-full bg-[#22c55e] hover:bg-[#16a34a] text-white font-semibold py-3.5 rounded-lg shadow-lg shadow-green-500/20 flex items-center justify-center gap-2 mt-4 text-lg">
                    <span>Login & Start</span>
                </button>
                <button onclick="App.toggleTeacherMode(false)" title="Cancel"
                    class="w-full py-2 text-sm font-semibold text-gray-400 hover:text-gray-600">
                    Cancel
                </button>
            </div>


            <!-- Footer / Toggle -->
            <div id="login-footer" class="text-center animate-slide-up mt-auto pt-4" style="animation-delay: 0.2s;">
                <button onclick="App.toggleTeacherMode(true)" title="Switch to Teacher Mode"
                    class="w-full py-3.5 rounded-lg font-semibold text-white bg-[#22c55e] hover:bg-[#16a34a] shadow-lg shadow-green-500/20 transition-all flex items-center justify-center gap-2">
                    <span>Teacher</span>
                </button>
            </div>
        </section>

        <!-- ================= VIEW: TEACHER LOBBY (QR) ================= -->
        <section id="view-lobby" class="view-hidden w-full h-full flex flex-col bg-white text-center p-8">
            <div class="flex-1 flex flex-col items-center justify-center space-y-8 animate-slide-up">
                <h2 class="text-2xl font-bold text-gray-900">Classroom Ready</h2>

                <div class="bg-white p-6 rounded-3xl shadow-xl border border-gray-100 relative">
                    <div class="absolute inset-0 bg-blue-500/5 rounded-3xl blur-xl -z-10"></div>
                    <!-- QR Placeholder -->
                    <div
                        class="w-48 h-48 bg-blue-50 rounded-xl flex items-center justify-center text-blue-600 text-6xl shadow-inner mb-4 border border-blue-100">
                        <i class="fa-solid fa-qrcode"></i>
                    </div>
                    <div class="space-y-1">
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Room Code</p>
                        <p id="lobby-code" class="text-4xl font-mono font-black text-blue-600 tracking-widest">----</p>
                    </div>
                </div>

                <p class="text-gray-500 max-w-xs mx-auto text-sm">Share this code with students to let them join the
                    conversation.</p>
            </div>

            <button onclick="App.startSession()" title="Start Session"
                class="btn-modern w-full bg-[#22c55e] hover:bg-[#16a34a] text-white font-bold py-4 rounded-xl shadow-lg shadow-green-500/20 flex items-center justify-center gap-3 animate-slide-up">
                <span>Start Session</span>
                <i class="fa-solid fa-play"></i>
            </button>
        </section>

        <!-- ================= VIEW: STUDENT ================= -->
        <section id="view-student" class="view-hidden w-full h-full flex flex-col bg-white">
            <!-- Navbar -->
            <header
                class="h-16 px-6 flex items-center justify-between bg-white/80 backdrop-blur-md sticky top-0 z-30 border-b border-gray-100">
                <div class="flex items-center gap-3">
                    <button onclick="App.logout()" title="Logout"
                        class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-500 hover:text-gray-900 transition-colors">
                        <i class="fa-solid fa-arrow-left text-sm"></i>
                    </button>
                    <div>
                        <h2 id="student-name-display"
                            class="font-bold text-gray-900 leading-tight text-sm text-truncate max-w-[120px]">Student
                        </h2>
                        <div class="flex items-center gap-1">
                            <span class="text-[9px] text-gray-400 font-bold uppercase tracking-tight">Receiving:</span>
                            <span id="student-lang-badge"
                                class="text-[10px] font-black uppercase text-blue-600">EN</span>
                        </div>
                    </div>
                </div>
                <!-- Status & Audio Toggle -->
                <div class="flex items-center gap-4">
                    <button onclick="App.toggleModal('history')" title="View History"
                        class="text-gray-400 hover:text-blue-500 transition-colors">
                        <i class="fa-solid fa-clock-rotate-left"></i>
                    </button>
                    <button id="tts-btn" onclick="App.toggleTTS()" title="Toggle Voice Output"
                        class="text-gray-400 hover:text-blue-500 transition-colors">
                        <i id="tts-icon" class="fa-solid fa-volume-xmark"></i>
                    </button>
                    <span class="relative flex h-3 w-3">
                        <span
                            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                    </span>
                </div>
            </header>

            <!-- Chat Stream -->
            <div id="student-stream"
                class="flex-1 overflow-y-auto p-6 space-y-6 pb-32 bg-gray-50/50 custom-scrollbar scroll-smooth">
                <!-- Welcome Message -->
                <div class="text-center py-10 opacity-60">
                    <div
                        class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-400 text-xl">
                        <i class="fa-solid fa-ear-listen"></i>
                    </div>
                    <p class="text-sm font-medium text-gray-500">Connected to <span
                            class="font-mono text-gray-700 font-bold" id="student-room-code">...</span></p>
                    <p class="text-xs text-gray-400 mt-1">Listening for speech...</p>
                </div>
            </div>

            <!-- Controls -->
            <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-white via-white to-transparent z-20">
                <div class="flex items-center justify-between gap-4">
                    <!-- Reactions & Speak Request -->
                    <div class="flex items-center gap-3">
                        <button onclick="App.sendReaction('ğŸ‘')" title="Thumbs Up"
                            class="btn-modern w-10 h-10 rounded-full bg-white border border-gray-200 shadow-sm text-lg flex items-center justify-center hover:bg-gray-50">ğŸ‘</button>
                        <button onclick="App.sendReaction('â¤ï¸')" title="Heart"
                            class="btn-modern w-10 h-10 rounded-full bg-white border border-gray-200 shadow-sm text-lg flex items-center justify-center hover:bg-gray-50">â¤ï¸</button>
                        <button id="student-speak-btn" onclick="App.requestSpeak()" title="Request to Speak"
                            class="btn-modern w-10 h-10 rounded-full bg-white border border-gray-200 shadow-sm text-lg flex items-center justify-center hover:bg-blue-50 hover:text-blue-500 transition-all text-gray-400">
                            <i class="fa-solid fa-microphone"></i>
                        </button>
                    </div>

                    <!-- Ask Question FAB -->
                    <button onclick="App.toggleModal('question')" title="Ask Question"
                        class="btn-modern h-12 px-6 rounded-full bg-[#0ea5e9] hover:bg-[#0284c7] text-white font-semibold shadow-lg shadow-blue-500/20 flex items-center gap-2">
                        <i class="fa-solid fa-paper-plane"></i>
                        <span>Ask</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- ================= VIEW: TEACHER (DASHBOARD) ================= -->
        <section id="view-teacher" class="view-hidden w-full h-full flex flex-col bg-slate-50">
            <!-- Header -->
            <header
                class="h-16 px-6 bg-white border-b border-gray-200 flex justify-between items-center shadow-sm z-30">
                <div class="flex items-center gap-3">
                    <button onclick="App.logout()" title="Logout"
                        class="text-gray-400 hover:text-red-500 transition-colors">
                        <i class="fa-solid fa-power-off"></i>
                    </button>
                    <div class="h-6 w-px bg-gray-200 mx-1"></div>
                    <div>
                        <h1 class="font-bold text-gray-900 text-sm">Teacher Panel</h1>
                        <div class="flex items-center gap-1.5 cursor-pointer hover:bg-gray-100 px-1.5 rounded transition-colors"
                            onclick="App.copyCode()">
                            <p class="text-xs text-gray-500 font-mono tracking-wider " id="teacher-code-display">CODE
                            </p>
                            <i class="fa-regular fa-copy text-[10px] text-gray-400"></i>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex items-center gap-4">
                    <button id="mic-btn" onclick="App.toggleMic()" title="Start Broadcasting"
                        class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-red-50 hover:text-red-500 transition-all">
                        <i class="fa-solid fa-microphone-slash"></i>
                    </button>
                    <div class="h-8 w-px bg-gray-100 mx-1"></div>
                    <button onclick="App.toggleModal('history')" title="View History"
                        class="text-gray-400 hover:text-blue-500 transition-colors">
                        <i class="fa-solid fa-clock-rotate-left"></i>
                    </button>
                    <button id="teacher-tts-btn" onclick="App.toggleTTS()" title="Toggle Voice Output"
                        class="text-gray-400 hover:text-blue-500 transition-colors">
                        <i id="teacher-tts-icon" class="fa-solid fa-volume-xmark"></i>
                    </button>
                </div>
            </header>

            <main class="flex-1 p-4 grid grid-rows-2 gap-4 h-[calc(100%-4rem)]">
                <!-- Live Transcript Area -->
                <div
                    class="bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col overflow-hidden relative group">
                    <div class="px-4 py-3 bg-gray-50/50 border-b border-gray-100 flex justify-between items-center">
                        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider flex items-center gap-2">
                            <i class="fa-solid fa-wave-square text-blue-500"></i> Live Audio
                        </h3>
                        <div id="mic-status" class="flex gap-1">
                            <div class="w-1 h-3 bg-gray-300 rounded-full animate-pulse"></div>
                            <div class="w-1 h-3 bg-gray-300 rounded-full animate-pulse" style="animation-delay: 0.1s">
                            </div>
                            <div class="w-1 h-3 bg-gray-300 rounded-full animate-pulse" style="animation-delay: 0.2s">
                            </div>
                        </div>
                    </div>

                    <div id="teacher-transcript"
                        class="flex-1 p-5 overflow-y-auto text-xl font-medium text-gray-400 italic leading-relaxed custom-scrollbar">
                        Tap the microphone to start broadcasting...
                    </div>
                </div>

                <!-- Questions & Requests -->
                <div class="grid grid-cols-2 gap-4">
                    <!-- Incoming Questions -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col overflow-hidden">
                        <div class="px-4 py-3 bg-gray-50/50 border-b border-gray-100 flex justify-between items-center">
                            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider">Questions</h3>
                            <span id="question-count"
                                class="bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                        </div>
                        <div id="teacher-questions"
                            class="flex-1 p-4 overflow-y-auto space-y-3 bg-gray-50/30 custom-scrollbar">
                            <div class="text-center py-4 opacity-40">
                                <p class="text-[10px]">No questions</p>
                            </div>
                        </div>
                    </div>

                    <!-- Speak Requests -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col overflow-hidden">
                        <div class="px-4 py-3 bg-gray-50/50 border-b border-gray-100 flex justify-between items-center">
                            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider">Speak Queue</h3>
                            <span id="request-count"
                                class="bg-green-100 text-green-700 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                        </div>
                        <div id="teacher-requests"
                            class="flex-1 p-4 overflow-y-auto space-y-2 bg-gray-50/30 custom-scrollbar">
                            <div class="text-center py-4 opacity-40">
                                <p class="text-[10px]">Empty Queue</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </section>

        <!-- ================= MODAL: QUESTION SELECTION ================= -->
        <div id="modal-question" class="fixed inset-0 z-50 hidden">
            <div class="absolute inset-0 bg-gray-900/40 backdrop-blur-sm transition-opacity opacity-0"
                id="modal-backdrop" onclick="App.toggleModal('question')"></div>
            <div class="absolute bottom-0 left-0 right-0 md:top-1/2 md:left-1/2 md:bottom-auto md:w-full md:max-w-sm md:-translate-x-1/2 md:-translate-y-1/2 transition-transform transform translate-y-full"
                id="modal-panel">
                <div class="bg-white rounded-t-3xl md:rounded-3xl shadow-2xl p-6">
                    <h3 class="text-xl font-black text-gray-900 mb-1">Ask a Question</h3>
                    <p class="text-sm text-gray-500 mb-6">Choose how you would like to participate.</p>

                    <div class="grid gap-4">
                        <button onclick="App.switchQuestionMode('type')"
                            class="w-full p-4 rounded-2xl border-2 border-gray-100 flex items-center gap-4 hover:border-blue-500 hover:bg-blue-50/50 transition-all text-left">
                            <div
                                class="w-12 h-12 rounded-xl bg-blue-100 text-blue-600 flex items-center justify-center text-xl">
                                <i class="fa-solid fa-keyboard"></i>
                            </div>
                            <div>
                                <p class="font-bold text-gray-900">Type Question</p>
                                <p class="text-xs text-gray-500">Send a text message</p>
                            </div>
                        </button>

                        <button id="btn-speak-mode" onclick="App.switchQuestionMode('speak')" title="Speak Question"
                            class="w-full p-4 rounded-2xl border-2 border-gray-100 flex items-center gap-4 hover:border-green-500 hover:bg-green-50/50 transition-all text-left disabled:opacity-50 disabled:grayscale disabled:cursor-not-allowed">
                            <div
                                class="w-12 h-12 rounded-xl bg-green-100 text-green-600 flex items-center justify-center text-xl">
                                <i class="fa-solid fa-microphone-lines"></i>
                            </div>
                            <div>
                                <p class="font-bold text-gray-900">Speak Question</p>
                                <p class="text-xs text-gray-500">Record your voice</p>
                            </div>
                        </button>
                    </div>

                    <button onclick="App.toggleModal('question')" title="Cancel"
                        class="w-full mt-6 py-3 text-sm font-bold text-gray-400 hover:text-gray-600 transition-colors">Cancel</button>
                </div>
            </div>
        </div>

        <!-- ================= MODAL: TEXT INPUT ================= -->
        <div id="modal-text-input" class="fixed inset-0 z-50 hidden">
            <div class="absolute inset-0 bg-gray-900/40 backdrop-blur-sm" onclick="App.toggleModal('text-input')"
                title="Close Overlay"></div>
            <div
                class="absolute bottom-0 left-0 right-0 md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 p-6">
                <div class="bg-white rounded-3xl shadow-2xl p-6 max-w-sm mx-auto">
                    <h3 class="font-black text-gray-900 mb-4">Type Your Question</h3>
                    <input id="q-input" type="text"
                        class="w-full border-2 border-gray-100 rounded-xl px-4 py-3 text-base outline-none focus:border-blue-500 mb-4"
                        placeholder="What is the topic about?">
                    <div class="flex gap-2">
                        <button onclick="App.toggleModal('text-input')" title="Back"
                            class="flex-1 py-3 font-bold text-gray-400 bg-gray-100 rounded-xl">Back</button>
                        <button onclick="App.sendQuestion()" title="Send Question"
                            class="flex-2 py-3 font-bold text-white bg-blue-600 rounded-xl shadow-lg shadow-blue-500/20">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= MODAL: RECORDING ================= -->
        <div id="modal-recording" class="fixed inset-0 z-50 hidden">
            <div
                class="absolute inset-0 bg-blue-600/95 backdrop-blur-xl flex flex-col items-center justify-center text-white p-8">
                <div class="w-24 h-24 bg-white/20 rounded-full flex items-center justify-center animate-pulse mb-8">
                    <i class="fa-solid fa-microphone-lines text-4xl"></i>
                </div>
                <h2 class="text-3xl font-black mb-2">Recording...</h2>
                <p class="text-blue-100 mb-12 text-center">Speak clearly. We'll translate your question.</p>

                <div id="recording-timer" class="text-4xl font-mono font-bold mb-12 tracking-widest">00:00</div>

                <button onclick="App.stopStudentRecording()" title="Stop Recording"
                    class="w-20 h-20 rounded-full bg-white text-blue-600 flex items-center justify-center text-2xl shadow-2xl hover:scale-110 transition-transform active:scale-90">
                    <i class="fa-solid fa-stop"></i>
                </button>
            </div>
        </div>

        <!-- ================= MODAL: HISTORY ================= -->
        <div id="modal-history" class="fixed inset-0 z-50 hidden bg-white">
            <div class="flex flex-col h-full bg-slate-50">
                <!-- Header -->
                <header
                    class="h-16 border-b border-gray-100 flex items-center justify-between px-6 bg-white/80 backdrop-blur-md sticky top-0 z-20">
                    <div class="flex items-center gap-4">
                        <button onclick="App.toggleModal('history')" title="Close History"
                            class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center text-gray-400 hover:text-gray-900 transition-all">
                            <i class="fa-solid fa-arrow-left text-xl"></i>
                        </button>
                        <div>
                            <h2 class="text-lg font-black text-gray-900 leading-none">History</h2>
                            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mt-1">Session
                                Archives</p>
                        </div>
                    </div>
                </header>

                <div class="flex flex-1 overflow-hidden relative">
                    <!-- Sidebar: Session List -->
                    <aside
                        class="absolute inset-0 md:relative md:inset-auto md:w-80 border-r border-gray-100 bg-white overflow-y-auto z-10 transition-transform duration-300 transform"
                        id="history-sidebar">
                        <div class="p-4 space-y-3" id="history-sessions">
                            <!-- Sessions injected here -->
                        </div>
                    </aside>

                    <!-- Main Content: Message View -->
                    <main class="flex-1 flex flex-col bg-slate-50 overflow-hidden relative z-0">
                        <div id="history-content-header"
                            class="p-4 border-b border-gray-100 bg-white flex items-center gap-3 hidden">
                            <button onclick="App.backToHistoryList()" title="Back to Sessions"
                                class="md:hidden w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 text-xs">
                                <i class="fa-solid fa-chevron-left"></i>
                            </button>
                            <div>
                                <h3 id="history-room-title" class="font-bold text-gray-900 text-sm">Room: ----</h3>
                                <p id="history-room-date" class="text-[9px] text-gray-400 font-bold uppercase">Jan 31,
                                    2026</p>
                            </div>
                        </div>
                        <div id="history-content"
                            class="flex-1 overflow-y-auto p-6 space-y-4 custom-scrollbar bg-slate-50">
                            <div class="h-full flex flex-col items-center justify-center text-center px-10">
                                <div
                                    class="w-20 h-20 bg-white rounded-3xl shadow-sm border border-gray-100 flex items-center justify-center text-gray-200 text-4xl mb-6">
                                    <i class="fa-solid fa-clock-rotate-left"></i>
                                </div>
                                <h4 class="font-bold text-gray-900 mb-2">Select a Session</h4>
                                <p class="text-sm text-gray-400">Choose a room from the sidebar to view the transcript
                                    archive.</p>
                            </div>
                        </div>
                    </main>
                </div>
            </div>
        </div>

    </main>

    <!-- ================= LOGIC ================= -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, remove, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { createClient, LiveTranscriptionEvents } from 'https://cdn.jsdelivr.net/npm/@deepgram/sdk@3/+esm';

        // --- CREDENTIALS ---
        const CREDENTIALS = {
            DEEPGRAM: "11ee938d032ce7c36c6fa82338274be5e4ada847",
            CARTESIA: "sk_car_yWEX9Mp2LwKju8FXyosGhj",
            CARTESIA_VOICES: {
                "en": "cbaf8084-f009-4838-a096-07ee2e6612b1", // Cathy
                "hi": "faf0731e-dfb9-4cfc-8119-259a79b27e12", // Riya
                "es": "5c5ad5e7-1020-476b-8b91-fdcbe9cc313c", // Daniela
                "de": "38aabb6a-f52b-4fb0-a3d1-988518f4dc06", // Alina
                "ar": "002622d8-19d0-4567-a16a-f99c7397c062", // Huda
                "te": "07bc462a-c644-49f1-baf7-82d5599131be", // Sindhu
                "nl-NL": "9e8db62d-056f-47f3-b3b6-1b05767f9176", // Dutch Netherlands
                "nl-BE": "aa3fdf22-9f5e-4238-8016-31f515ded9a3", // Flemish
                "fr": "0418348a-0ca2-4e90-9986-800fb8b3bbc0", // French
                "uk": "05ffab9c-d380-4909-8375-cd12f59238c3", // Ukrainian
                "tl": "c4cbcb7d-d9fa-4eac-b547-46831718ef58", // Tagalog
                "default": "cbaf8084-f009-4838-a096-07ee2e6612b1"
            },
            FIREBASE: {
                apiKey: "AIzaSyC93B2GgE3HzaWl5gW_mRroobQybaZNFJs",
                authDomain: "macx-5feca.firebaseapp.com",
                databaseURL: "https://macx-5feca-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "macx-5feca",
                storageBucket: "macx-5feca.appspot.com",
                messagingSenderId: "123456789012",
                appId: "1:123456789012:web:abcdef1234567890abcdef"
            }
        };

        const LANGUAGES = [
            { code: 'en', name: 'English (United States)', flag: 'ğŸ‡ºğŸ‡¸' },
            { code: 'es', name: 'Spanish (EspaÃ±ol)', flag: 'ğŸ‡ªğŸ‡¸' },
            { code: 'fr', name: 'French (FranÃ§ais)', flag: 'ğŸ‡«ğŸ‡·' },
            { code: 'de', name: 'German (Deutsch)', flag: 'ğŸ‡©ğŸ‡ª' },
            { code: 'zh', name: 'Chinese (ä¸­æ–‡ - Mandarin)', flag: 'ğŸ‡¨ğŸ‡³' },
            { code: 'hi', name: 'Hindi (à¤¹à¤¿à¤¨à¥à¤¦à¥€)', flag: 'ğŸ‡®ğŸ‡³' },
            { code: 'ar', name: 'Arabic (Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)', flag: 'ğŸ‡¸ğŸ‡¦' },
            { code: 'pt', name: 'Portuguese (PortuguÃªs)', flag: 'ğŸ‡µğŸ‡¹' },
            { code: 'bn', name: 'Bengali (à¦¬à¦¾à¦‚à¦²à¦¾)', flag: 'ğŸ‡§ğŸ‡©' },
            { code: 'ru', name: 'Russian (Ğ ÑƒÑÑĞºĞ¸Ğ¹)', flag: 'ğŸ‡·ğŸ‡º' },
            { code: 'ja', name: 'Japanese (æ—¥æœ¬èª)', flag: 'ğŸ‡¯ğŸ‡µ' },
            { code: 'ko', name: 'Korean (í•œêµ­ì–´)', flag: 'ğŸ‡°ğŸ‡·' },
            { code: 'vi', name: 'Vietnamese (Tiáº¿ng Viá»‡t)', flag: 'ğŸ‡»ğŸ‡³' },
            { code: 'it', name: 'Italian (Italiano)', flag: 'ğŸ‡®ğŸ‡¹' },
            { code: 'tr', name: 'Turkish (TÃ¼rkÃ§e)', flag: 'ğŸ‡¹ğŸ‡·' },

            // --- BENELUX ---
            { code: 'nl-NL', name: 'Dutch Netherlands', flag: 'ğŸ‡³ğŸ‡±' },
            { code: 'nl-BE', name: 'Dutch Belgium', flag: 'ğŸ‡§ğŸ‡ª' },
            { code: 'lb', name: 'Luxembourgish (LÃ«tzebuergesch)', flag: 'ğŸ‡±ğŸ‡º' },

            // --- FRANCE & REGIONAL ---
            { code: 'br', name: 'Breton (Brezhoneg)', flag: 'ğŸ‡«ğŸ‡·' },
            { code: 'oc', name: 'Occitan (Occitan)', flag: 'ğŸ‡«ğŸ‡·' },
            { code: 'co', name: 'Corsican (Corsu)', flag: 'ğŸ‡«ğŸ‡·' },
            { code: 'gsw-FR', name: 'Alsatian (ElsÃ¤ssisch)', flag: 'ğŸ‡«ğŸ‡·' },
            { code: 'eu', name: 'Basque (Euskara)', flag: 'ğŸ‡ªğŸ‡¸' },
            { code: 'ca', name: 'Catalan (CatalÃ )', flag: 'ğŸ‡ªğŸ‡¸' },

            // --- GERMANY & REGIONAL ---
            { code: 'nds', name: 'Low German (Plattdeutsch)', flag: 'ğŸ‡©ğŸ‡ª' },
            { code: 'hsb', name: 'Upper Sorbian (HornjoserbÅ¡Ä‡ina)', flag: 'ğŸ‡©ğŸ‡ª' },
            { code: 'dsb', name: 'Lower Sorbian (DolnoserbÅ¡Ä‡ina)', flag: 'ğŸ‡©ğŸ‡ª' },
            { code: 'bar', name: 'Bavarian (Boarisch)', flag: 'ğŸ‡©ğŸ‡ª' },
            { code: 'swg', name: 'Swabian (SchwÃ¤à¤¬à¤¿à¤¶)', flag: 'ğŸ‡©ğŸ‡ª' },
            { code: 'pfl', name: 'Palatine German (PÃ¤lzisch)', flag: 'ğŸ‡©ğŸ‡ª' },
            { code: 'ksh', name: 'Colognian (KÃ¶lsch)', flag: 'ğŸ‡©ğŸ‡ª' },
            { code: 'de-AT', name: 'Austrian German (Ã–sterreichisches Deutsch)', flag: 'ğŸ‡¦ğŸ‡¹' },
            { code: 'de-CH', name: 'Swiss German (SchwiizerdÃ¼tsch)', flag: 'ğŸ‡¨ğŸ‡­' },

            // --- EUROPEAN BROAD ---
            { code: 'pl', name: 'Polish (Polski)', flag: 'ğŸ‡µğŸ‡±' },
            { code: 'uk', name: 'Ukrainian (Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°)', flag: 'ğŸ‡ºğŸ‡¦' },
            { code: 'ro', name: 'Romanian (RomÃ¢nÄƒ)', flag: 'ğŸ‡·ğŸ‡´' },
            { code: 'el', name: 'Greek (Î•Î»Î»Î·Î½Î¹ÎºÎ¬)', flag: 'ğŸ‡¬ğŸ‡·' },
            { code: 'cs', name: 'Czech (ÄŒeÅ¡tina)', flag: 'ğŸ‡¨ğŸ‡¿' },
            { code: 'hu', name: 'Hungarian (Magyar)', flag: 'ğŸ‡­ğŸ‡º' },
            { code: 'sv', name: 'Swedish (Svenska)', flag: 'ï¿½ğŸ‡ª' },
            { code: 'da', name: 'Danish (Dansk)', flag: 'ğŸ‡©ğŸ‡°' },
            { code: 'no', name: 'Norwegian (Norsk)', flag: 'ğŸ‡³ğŸ‡´' },
            { code: 'fi', name: 'Finnish (Suomi)', flag: 'ï¿½ğŸ‡«ï¿½' },
            { code: 'sk', name: 'Slovak (SlovenÄina)', flag: 'ğŸ‡¸ğŸ‡°' },
            { code: 'bg', name: 'Bulgarian (Ğ‘ÑŠĞ»Ğ³Ğ°Ñ€ÑĞºĞ¸)', flag: 'ğŸ‡§ğŸ‡¬' },
            { code: 'hr', name: 'Croatian (Hrvatski)', flag: 'ğŸ‡­ï¿½ğŸ‡·' },
            { code: 'sr', name: 'Serbian (Ğ¡Ñ€Ğ¿ÑĞºĞ¸)', flag: 'ğŸ‡·ğŸ‡¸' },
            { code: 'sl', name: 'Slovenian (SlovenÅ¡Äina)', flag: 'ğŸ‡¸ğŸ‡®' },
            { code: 'lt', name: 'Lithuanian (LietuviÅ³)', flag: 'ğŸ‡±ğŸ‡¹' },
            { code: 'lv', name: 'Latvian (LatvieÅ¡u)', flag: 'ğŸ‡±ğŸ‡»' },
            { code: 'et', name: 'Estonian (Eesti)', flag: 'ğŸ‡ªğŸ‡ª' },
            { code: 'is', name: 'Icelandic (ÃØ³Ù„enska)', flag: 'ğŸ‡®ğŸ‡¸' },
            { code: 'ga', name: 'Irish (Gaeilge)', flag: 'ğŸ‡®ğŸ‡ª' },
            { code: 'cy', name: 'Welsh (Cymraeg)', flag: 'ğŸ‡¬ğŸ‡§' },
            { code: 'gd', name: 'Scottish Gaelic (GÃ idhlig)', flag: 'ğŸ´ó §ó ¢ó ³ó £ó ´ó ¿' },
            { code: 'sq', name: 'Albanian (Shqip)', flag: 'ğŸ‡¦ğŸ‡±' },
            { code: 'mk', name: 'Macedonian (ĞœĞ°ĞºĞµĞ´Ğ¾Ğ½ÑĞºĞ¸)', flag: 'ğŸ‡²ğŸ‡°' },
            { code: 'mt', name: 'Maltese (Malti)', flag: 'ğŸ‡²ğŸ‡¹' },

            // --- ASIA & PACIFIC ---
            { code: 'th', name: 'Thai (à¹„à¸—à¸¢)', flag: 'ğŸ‡¹ğŸ‡­' },
            { code: 'id', name: 'Indonesian (Bahasa Indonesia)', flag: 'ğŸ‡®ğŸ‡©' },
            { code: 'ms', name: 'Malay (Bahasa Melayu)', flag: 'ğŸ‡²ğŸ‡¾' },
            { code: 'tl', name: 'Tagalog (Filipino)', flag: 'ğŸ‡µğŸ‡­' },
            { code: 'pa', name: 'Punjabi (à¨ªà©°à¨œà¨¾à¨¬à©€)', flag: 'ğŸ‡®ğŸ‡³' },
            { code: 'te', name: 'Telugu (à°¤à±†à°²à±à°—à±)', flag: 'ğŸ‡®ğŸ‡³' },
            { code: 'mr', name: 'Marathi (à¤®à¤°à¤¾à¤ à¥€)', flag: 'ğŸ‡®ğŸ‡³' },
            { code: 'ta', name: 'Tamil (à®¤à®®à®¿à®´à¯)', flag: 'ğŸ‡®ğŸ‡³' },
            { code: 'gu', name: 'Gujarati (àª—à«àªœàª°àª¾àª¤à«€)', flag: 'ğŸ‡®ğŸ‡³' },
            { code: 'kn', name: 'Kannada (à¨•à²¨à³à²¨à²¡)', flag: 'ğŸ‡®ğŸ‡³' },
            { code: 'ml', name: 'Malayalam (à´®à´²à´¯à´¾à´³à´‚)', flag: 'ğŸ‡®ğŸ‡³' },
            { code: 'my', name: 'Burmese (á€™á€¼à¸±à¸™á€™á€¬á€…á€¬)', flag: 'ğŸ‡²ğŸ‡²' },
            { code: 'km', name: 'Khmer (ááŸ’á˜áŸ‚áš)', flag: 'ğŸ‡°ğŸ‡­' },
            { code: 'lo', name: 'Lao (à¸¥à¸²à¸§)', flag: 'ğŸ‡±ğŸ‡¦' },
            { code: 'si', name: 'Sinhala (à·ƒà·’à¶‚à·„à¶½)', flag: 'ğŸ‡±ğŸ‡°' },
            { code: 'ne', name: 'Nepali (à¤¨à¥‡à¤ªà¤¾à¤²à¥€)', flag: 'ğŸ‡³ğŸ‡µ' },

            // --- AFRICA ---
            { code: 'sw', name: 'Swahili (Kiswahili)', flag: 'ğŸ‡¹ğŸ‡¿' },
            { code: 'am', name: 'Amharic (áŠ áˆ›áˆ­áŠ›)', flag: 'ğŸ‡ªğŸ‡¹' },
            { code: 'yo', name: 'Yoruba (YorÃ¹bÃ¡)', flag: 'ğŸ‡³ğŸ‡¬' },
            { code: 'ig', name: 'Igbo (Asá»¥sá»¥ Igbo)', flag: 'ğŸ‡³ğŸ‡¬' },
            { code: 'zu', name: 'Zulu (isiZulu)', flag: 'ğŸ‡¿ğŸ‡¦' },

            // --- ADDITIONAL 100+ LANGUAGES ---
            { code: 'aa', name: 'Afar', flag: 'ğŸ‡ªğŸ‡¹' },
            { code: 'ace', name: 'Acehnese', flag: 'ğŸ‡®ğŸ‡©' },
            { code: 'ach', name: 'Acholi', flag: 'ğŸ‡ºğŸ‡¬' },
            { code: 'ada', name: 'Adangme', flag: 'ğŸ‡¬ğŸ‡­' },
            { code: 'ady', name: 'Adyghe', flag: 'ğŸ‡·ğŸ‡º' },
            { code: 'ak', name: 'Akan', flag: 'ğŸ‡¬ğŸ‡­' },
            { code: 'alt', name: 'Southern Altai', flag: 'ğŸ‡·ğŸ‡º' },
            { code: 'av', name: 'Avaric', flag: 'ğŸ‡·ğŸ‡º' },
            { code: 'awa', name: 'Awadhi', flag: 'ğŸ‡®ğŸ‡³' },
            { code: 'bal', name: 'Baluchi', flag: 'ğŸ‡µğŸ‡°' },
            { code: 'ban', name: 'Balinese', flag: 'ğŸ‡®ğŸ‡©' },
            { code: 'ba', name: 'Bashkir', flag: 'ğŸ‡·ğŸ‡º' },
            { code: 'bjn', name: 'Banjar', flag: 'ğŸ‡®ğŸ‡©' },
            { code: 'bho', name: 'Bhojpuri', flag: 'ğŸ‡®ğŸ‡³' },
            { code: 'bik', name: 'Bikol', flag: 'ğŸ‡µğŸ‡­' },
            { code: 'bin', name: 'Bini', flag: 'ğŸ‡³ğŸ‡¬' },
            { code: 'bug', name: 'Buginese', flag: 'ğŸ‡®ğŸ‡©' },
            { code: 'ce', name: 'Chechen', flag: 'ğŸ‡·ğŸ‡º' },
            { code: 'ch', name: 'Chamorro', flag: 'ğŸ‡¬ğŸ‡º' },
            { code: 'chk', name: 'Chuukese', flag: 'ğŸ‡«ğŸ‡²' },
            { code: 'chm', name: 'Mari', flag: 'ğŸ‡·ğŸ‡º' },
            { code: 'cho', name: 'Choctaw', flag: 'ğŸ‡ºğŸ‡¸' },
            { code: 'chr', name: 'Cherokee', flag: 'ğŸ‡ºğŸ‡¸' },
            { code: 'cv', name: 'Chuvash', flag: 'ğŸ‡·ğŸ‡º' },
            { code: 'dar', name: 'Dargwa', flag: 'ğŸ‡·ğŸ‡º' },
            { code: 'dv', name: 'Divehi', flag: 'ğŸ‡²ğŸ‡»' },
            { code: 'dz', name: 'Dzongkha', flag: 'ğŸ‡§ğŸ‡¹' },
            { code: 'efi', name: 'Efik', flag: 'ğŸ‡³ğŸ‡¬' },
            { code: 'fat', name: 'Fanti', flag: 'ğŸ‡¬ğŸ‡­' },
            { code: 'fj', name: 'Fijian', flag: 'ğŸ‡«ğŸ‡¯' },
            { code: 'fon', name: 'Fon', flag: 'ğŸ‡§ğŸ‡¯' },
            { code: 'fur', name: 'Friulian', flag: 'ğŸ‡®ğŸ‡¹' },
            { code: 'gaa', name: 'Ga', flag: 'ğŸ‡¬ğŸ‡­' },
            { code: 'gez', name: 'Geez', flag: 'ğŸ‡ªğŸ‡¹' },
            { code: 'gil', name: 'Gilbertese', flag: 'ğŸ‡°ğŸ‡®' },
            { code: 'gor', name: 'Gorontalo', flag: 'ğŸ‡®ğŸ‡©' },
            { code: 'gwi', name: 'Gwich\'in', flag: 'ğŸ‡¨ğŸ‡¦' },
            { code: 'hil', name: 'Hiligaynon', flag: 'ğŸ‡µğŸ‡­' },
            { code: 'hmn', name: 'Hmong', flag: 'ğŸ‡¨ğŸ‡³' },
            { code: 'ho', name: 'Hiri Motu', flag: 'ğŸ‡µğŸ‡¬' },
            { code: 'iba', name: 'Iban', flag: 'ğŸ‡²ğŸ‡¾' },
            { code: 'ilo', name: 'Iloko', flag: 'ğŸ‡µğŸ‡­' },
            { code: 'inh', name: 'Ingush', flag: 'ğŸ‡·ğŸ‡º' },
            { code: 'iu', name: 'Inuktitut', flag: 'ğŸ‡¨ğŸ‡¦' },
            { code: 'jv', name: 'Javanese', flag: 'ğŸ‡®ğŸ‡©' },
            { code: 'kab', name: 'Kabyle', flag: 'ğŸ‡©ğŸ‡¿' },
            { code: 'kac', name: 'Kachin', flag: 'ğŸ‡²ğŸ‡²' },
            { code: 'kaj', name: 'Jju', flag: 'ğŸ‡³ğŸ‡¬' },
            { code: 'kam', name: 'Kamba', flag: 'ğŸ‡°ğŸ‡ª' },
            { code: 'kbd', name: 'Kabardian', flag: 'ğŸ‡·ğŸ‡º' },
            { code: 'kbp', name: 'Kabiye', flag: 'ğŸ‡¹ğŸ‡¬' },
            { code: 'kfo', name: 'Koro', flag: 'ğŸ‡¨ğŸ‡®' },
            { code: 'kg', name: 'Kongo', flag: 'ğŸ‡¨ğŸ‡©' },
            { code: 'kha', name: 'Khasi', flag: 'ğŸ‡®ğŸ‡³' },
            { code: 'ki', name: 'Kikuyu', flag: 'ğŸ‡°ğŸ‡ª' },
            { code: 'kj', name: 'Kuanyama', flag: 'ğŸ‡¦ğŸ‡´' },
            { code: 'kk', name: 'Kazakh', flag: 'ğŸ‡°ğŸ‡¿' },
            { code: 'kmb', name: 'Kimbundu', flag: 'ğŸ‡¦ğŸ‡´' },
            { code: 'kok', name: 'Konkani', flag: 'ğŸ‡®ğŸ‡³' },
            { code: 'kpe', name: 'Kpelle', flag: 'ğŸ‡±ğŸ‡·' },
            { code: 'kr', name: 'Kanuri', flag: 'ğŸ‡³ğŸ‡¬' },
            { code: 'krc', name: 'Karachay-Balkar', flag: 'ğŸ‡·ğŸ‡º' },
            { code: 'kru', name: 'Kurukh', flag: 'ğŸ‡®ğŸ‡³' },
            { code: 'ks', name: 'Kashmiri', flag: 'ğŸ‡®ğŸ‡³' },
            { code: 'kum', name: 'Kumyk', flag: 'ğŸ‡·ğŸ‡º' },
            { code: 'kv', name: 'Komi', flag: 'ğŸ‡·ğŸ‡º' },
            { code: 'kw', name: 'Cornish', flag: 'ğŸ‡¬ğŸ‡§' },
            { code: 'ky', name: 'Kirghiz', flag: 'ğŸ‡°ğŸ‡¬' },
            { code: 'lad', name: 'Ladino', flag: 'ğŸ‡®ğŸ‡±' },
            { code: 'lez', name: 'Lezghian', flag: 'ğŸ‡·ğŸ‡º' },
            { code: 'li', name: 'Limburgish', flag: 'ğŸ‡³ğŸ‡±' },
            { code: 'loz', name: 'Lozi', flag: 'ğŸ‡¿ğŸ‡²' },
            { code: 'lua', name: 'Luba-Lulua', flag: 'ğŸ‡¨ğŸ‡©' },
            { code: 'lun', name: 'Lunda', flag: 'ğŸ‡¿ğŸ‡²' },
            { code: 'lus', name: 'Lushai', flag: 'ğŸ‡®ğŸ‡³' },
            { code: 'mad', name: 'Madurese', flag: 'ğŸ‡®ğŸ‡©' },
            { code: 'mag', name: 'Magahi', flag: 'ğŸ‡®ğŸ‡³' },
            { code: 'mai', name: 'Maithili', flag: 'ğŸ‡®ğŸ‡³' },
            { code: 'mak', name: 'Makasar', flag: 'ğŸ‡®ğŸ‡©' },
            { code: 'man', name: 'Mandingo', flag: 'ğŸ‡¬ğŸ‡³' },
            { code: 'mas', name: 'Masai', flag: 'ğŸ‡°ğŸ‡ª' },
            { code: 'mdf', name: 'Moksha', flag: 'ğŸ‡·ğŸ‡º' },
            { code: 'mdr', name: 'Mandar', flag: 'ğŸ‡®ğŸ‡©' },
            { code: 'men', name: 'Mende', flag: 'ğŸ‡¸ğŸ‡±' },
            { code: 'min', name: 'Minangkabau', flag: 'ğŸ‡®ğŸ‡©' },
            { code: 'mni', name: 'Manipuri', flag: 'ğŸ‡®ğŸ‡³' },
            { code: 'mos', name: 'Mossi', flag: 'ğŸ‡§ğŸ‡«' },
            { code: 'mus', name: 'Creek', flag: 'ğŸ‡ºğŸ‡¸' },
            { code: 'mwl', name: 'Mirandese', flag: 'ğŸ‡µğŸ‡¹' },
            { code: 'myv', name: 'Erzya', flag: 'ğŸ‡·ğŸ‡º' },
            { code: 'na', name: 'Nauru', flag: 'ğŸ‡³ğŸ‡·' },
            { code: 'nap', name: 'Neapolitan', flag: 'ğŸ‡®ğŸ‡¹' },
            { code: 'new', name: 'Newari', flag: 'ğŸ‡³ğŸ‡µ' },
            { code: 'ng', name: 'Ndonga', flag: 'ğŸ‡³ğŸ‡¦' },
            { code: 'nia', name: 'Nias', flag: 'ğŸ‡®ğŸ‡©' },
            { code: 'niu', name: 'Niuean', flag: 'ğŸ‡³ğŸ‡º' },
            { code: 'nog', name: 'Nogai', flag: 'ğŸ‡·ğŸ‡º' },
            { code: 'nqo', name: 'N\'Ko', flag: 'ğŸ‡¬ğŸ‡³' },
            { code: 'nr', name: 'Ndebele, South', flag: 'ğŸ‡¿ğŸ‡¦' },
            { code: 'nso', name: 'Pedi', flag: 'ğŸ‡¿ğŸ‡¦' },
            { code: 'ny', name: 'Nyanja', flag: 'ğŸ‡²ğŸ‡¼' },
            { code: 'nyn', name: 'Nyankole', flag: 'ğŸ‡ºğŸ‡¬' },
            { code: 'pag', name: 'Pangasinan', flag: 'ğŸ‡µğŸ‡­' },
            { code: 'pam', name: 'Pampanga', flag: 'ğŸ‡µğŸ‡­' },
            { code: 'pap', name: 'Papiamento', flag: 'ğŸ‡¦ğŸ‡¼' },
            { code: 'pau', name: 'Palauan', flag: 'ğŸ‡µğŸ‡¼' },
            { code: 'pon', name: 'Pohnpeian', flag: 'ğŸ‡«ğŸ‡²' },
            { code: 'raj', name: 'Rajasthani', flag: 'ğŸ‡®ğŸ‡³' },
            { code: 'rar', name: 'Rarotongan', flag: 'ğŸ‡¨ğŸ‡°' },
            { code: 'rm', name: 'Raeto-Romance', flag: 'ğŸ‡¨ğŸ‡­' },
            { code: 'rom', name: 'Romany', flag: 'ğŸ‡ªğŸ‡º' },
            { code: 'rup', name: 'Aromanian', flag: 'ğŸ‡²ğŸ‡°' },
            { code: 'sad', name: 'Sandawe', flag: 'ğŸ‡¹ğŸ‡¿' },
            { code: 'sah', name: 'Yakut', flag: 'ğŸ‡·ğŸ‡º' },
            { code: 'sam', name: 'Samaritan Aramaic', flag: 'ğŸ‡®ğŸ‡±' },
            { code: 'sas', name: 'Sasak', flag: 'ğŸ‡®ğŸ‡©' },
            { code: 'sat', name: 'Santali', flag: 'ğŸ‡®ğŸ‡³' },
            { code: 'scn', name: 'Sicilian', flag: 'ğŸ‡®ğŸ‡¹' },
            { code: 'sco', name: 'Scots', flag: 'ğŸ‡¬ğŸ‡§' },
            { code: 'sel', name: 'Selkup', flag: 'ğŸ‡·ğŸ‡º' },
            { code: 'shn', name: 'Shan', flag: 'ğŸ‡²ğŸ‡²' },
            { code: 'sid', name: 'Sidamo', flag: 'ğŸ‡ªğŸ‡¹' },
            { code: 'sms', name: 'Skolt Sami', flag: 'ğŸ‡«ğŸ‡®' },
            { code: 'snk', name: 'Soninke', flag: 'ğŸ‡²ğŸ‡±' },
            { code: 'srn', name: 'Sranan Tongo', flag: 'ğŸ‡¸ğŸ‡·' },
            { code: 'ss', name: 'Swati', flag: 'ğŸ‡¸ğŸ‡¿' },
            { code: 'st', name: 'Sotho, Southern', flag: 'ğŸ‡±ğŸ‡¸' },
            { code: 'suk', name: 'Sukuma', flag: 'ğŸ‡¹ğŸ‡¿' },
            { code: 'sus', name: 'Susu', flag: 'ğŸ‡¬ğŸ‡³' },
            { code: 'syr', name: 'Syriac', flag: 'ğŸ‡®ğŸ‡¶' },
            { code: 'tem', name: 'Timne', flag: 'ğŸ‡¸ğŸ‡±' },
            { code: 'tet', name: 'Tetum', flag: 'ğŸ‡¹ğŸ‡±' },
            { code: 'tig', name: 'Tigre', flag: 'ğŸ‡ªğŸ‡·' },
            { code: 'tiv', name: 'Tiv', flag: 'ğŸ‡³ğŸ‡¬' },
            { code: 'tkl', name: 'Tokelau', flag: 'ğŸ‡¹ğŸ‡°' },
            { code: 'tlh', name: 'Klingon', flag: 'ğŸ––' },
            { code: 'tli', name: 'Tlingit', flag: 'ğŸ‡ºğŸ‡¸' },
            { code: 'tmh', name: 'Tamashek', flag: 'ğŸ‡²ğŸ‡±' },
            { code: 'tn', name: 'Tswana', flag: 'ğŸ‡¿ğŸ‡¦' },
            { code: 'to', name: 'Tonga', flag: 'ğŸ‡¹ğŸ‡´' },
            { code: 'tpi', name: 'Tok Pisin', flag: 'ğŸ‡µğŸ‡¬' },
            { code: 'ts', name: 'Tsonga', flag: 'ğŸ‡¿ğŸ‡¦' },
            { code: 'tt', name: 'Tatar', flag: 'ğŸ‡·ğŸ‡º' },
            { code: 'tum', name: 'Tumbuka', flag: 'ğŸ‡²ğŸ‡¼' },
            { code: 'tvl', name: 'Tuvalu', flag: 'ğŸ‡¹ğŸ‡»' },
            { code: 'ty', name: 'Tahitian', flag: 'ğŸ‡µğŸ‡«' },
            { code: 'tyv', name: 'Tuvinian', flag: 'ğŸ‡·ğŸ‡º' },
            { code: 'udm', name: 'Udmurt', flag: 'ğŸ‡·ğŸ‡º' },
            { code: 'umb', name: 'Umbundu', flag: 'ğŸ‡¦ğŸ‡´' },
            { code: 've', name: 'Venda', flag: 'ğŸ‡¿ğŸ‡¦' },
            { code: 'wa', name: 'Walloon', flag: 'ğŸ‡§ğŸ‡ª' },
            { code: 'war', name: 'Waray', flag: 'ğŸ‡µğŸ‡­' },
            { code: 'xal', name: 'Kalmyk', flag: 'ğŸ‡·ğŸ‡º' },
            { code: 'yao', name: 'Yao', flag: 'ğŸ‡²ğŸ‡¼' },
            { code: 'yap', name: 'Yapese', flag: 'ğŸ‡«ğŸ‡²' },
            { code: 'zun', name: 'Zuni', flag: 'ğŸ‡ºğŸ‡¸' }
        ];

        class SuccesApp {
            constructor() {
                this.app = initializeApp(CREDENTIALS.FIREBASE);
                this.db = getDatabase(this.app);

                this.state = {
                    role: null,
                    room: '',
                    name: '',
                    gender: 'Male',
                    lang: 'en',
                    isMicActive: false,
                    isTTSActive: false,
                    isAudioPlaying: false,
                    isStudentMicEnabled: false,
                    audioQueue: [],
                    history: []
                };

                this.deviceId = localStorage.getItem('orbit_device_id') || this.generateId();
                localStorage.setItem('orbit_device_id', this.deviceId);

                this.dgClient = null;
                this.dgSocket = null;
                this.mediaRecorder = null;
                this.wakeLock = null;

                this.bindAll();
                this.init();
            }

            saveState() {
                localStorage.setItem('orbit_session', JSON.stringify({
                    role: this.state.role,
                    room: this.state.room,
                    name: this.state.name,
                    lang: this.state.lang,
                    currentView: this.state.currentView
                }));
                if (this.state.room) this.saveRoomToHistory(this.state.room);
            }

            saveRoomToHistory(room) {
                const historyRef = ref(this.db, `users/${this.deviceId}/history/${room}`);
                import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js").then(db => {
                    db.set(historyRef, {
                        lastJoined: Date.now(),
                        roomCode: room
                    });
                });
            }

            generateId() {
                return 'dev_' + Math.random().toString(36).substr(2, 9);
            }

            clearState() {
                localStorage.removeItem('orbit_session');
            }

            bindAll() {
                ['handleLogin', 'handleTeacherLogin', 'toggleTeacherMode', 'startSession', 'logout', 'toggleMic', 'sendQuestion', 'toggleModal', 'sendReaction', 'toggleTTS'].forEach(m => this[m] = this[m].bind(this));
            }

            init() {
                // Populate both language selects
                const ops = LANGUAGES.map(l => `<option value="${l.code}" ${l.code === 'en' ? 'selected' : ''}>${l.flag || ''} ${l.name}</option>`).join('');
                document.getElementById('login-lang').innerHTML = ops;
                document.getElementById('teacher-lang').innerHTML = ops;
                window.App = this;

                // Restore Session
                const saved = localStorage.getItem('orbit_session');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        this.state = { ...this.state, ...data };

                        if (this.state.role === 'student' && this.state.room) {
                            this.initStudent();
                            this.switchView(this.state.currentView || 'view-student');
                        } else if (this.state.role === 'teacher' && this.state.room) {
                            if (this.state.currentView === 'view-teacher') {
                                this.initTeacher();
                                this.switchView('view-teacher');
                            } else {
                                document.getElementById('lobby-code').innerText = this.state.room;
                                this.switchView('view-lobby');
                            }
                        }
                    } catch (e) { this.clearState(); }
                }
                this.registerServiceWorker();
            }

            // --- NAVIGATION ---
            switchView(viewId) {
                this.state.currentView = viewId;
                this.saveState();

                document.querySelectorAll('section').forEach(el => {
                    el.classList.remove('view-active');
                    el.classList.add('view-hidden');
                });
                const target = document.getElementById(viewId);
                setTimeout(() => {
                    target.classList.remove('view-hidden');
                    target.classList.add('view-active');
                }, 50);
            }

            registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    const swCode = `
                        const CACHE_NAME = 'orbit-v1';
                        const ASSETS = ['./', './index.html', './pwa_icon.png'];
                        self.addEventListener('install', (e) => {
                            e.waitUntil(caches.open(CACHE_NAME).then((cache) => cache.addAll(ASSETS)));
                        });
                        self.addEventListener('fetch', (e) => {
                            e.respondWith(caches.match(e.request).then((res) => res || fetch(e.request)));
                        });
                    `;
                    const blob = new Blob([swCode], { type: 'application/javascript' });
                    const url = URL.createObjectURL(blob);
                    navigator.serviceWorker.register(url).catch(err => console.log('SW failed', err));
                }
            }

            async requestPermissions() {
                try {
                    await navigator.mediaDevices.getUserMedia({ audio: true });
                    if ('Notification' in window) {
                        await Notification.requestPermission();
                    }
                } catch (e) {
                    this.showToast("Mic permission required", "error");
                }
            }

            toggleModal(type) {
                const modal = document.getElementById(`modal-${type}`);
                const bd = document.getElementById(type === 'history' ? 'history-backdrop' : 'modal-backdrop');
                const panel = document.getElementById(type === 'history' ? 'history-panel' : 'modal-panel');

                if (modal.classList.contains('hidden')) {
                    modal.classList.remove('hidden');
                    if (type === 'history') {
                        this.loadHistory();
                        this.backToHistoryList(); // Reset view to list
                    }
                    setTimeout(() => {
                        if (bd) bd.style.opacity = '1';
                        if (panel) panel.style.transform = (window.innerWidth < 768) ? 'translateY(0)' : 'translate(-50%, -50%)';
                    }, 10);
                } else {
                    if (bd) bd.style.opacity = '0';
                    if (panel) panel.style.transform = (window.innerWidth < 768) ? 'translateY(100%)' : 'translate(-50%, 0)';
                    setTimeout(() => modal.classList.add('hidden'), 300);
                }
            }

            async loadHistory() {
                const container = document.getElementById('history-content');
                container.innerHTML = '<div class="text-center py-20 opacity-50"><i class="fa-solid fa-circle-notch animate-spin text-2xl"></i></div>';

                if (!this.state.room) return;

                try {
                    const data = [];
                    // Fetch Messages (Broadcasts)
                    const mSnap = await get(ref(this.db, `chats/${this.state.room}/messages`));
                    if (mSnap.exists()) {
                        mSnap.forEach(s => {
                            data.push({ ...s.val(), type: 'broadcast', ts: s.key });
                        });
                    }

                    // Fetch Questions
                    const qSnap = await get(ref(this.db, `chats/${this.state.room}/questions`));
                    if (qSnap.exists()) {
                        qSnap.forEach(s => {
                            data.push({ ...s.val(), type: 'question', ts: s.key });
                        });
                    }

                    // Sort by timestamp
                    data.sort((a, b) => b.ts.localeCompare(a.ts));

                    if (data.length === 0) {
                        container.innerHTML = '<div class="text-center py-20 opacity-30"><p class="text-sm font-bold">No history available</p></div>';
                        return;
                    }

                    container.innerHTML = '';
                    for (const item of data) {
                        if (this.state.role === 'student') {
                            if (item.type === 'broadcast') {
                                const trans = await this.translateText(item.text, item.lang, this.state.lang);
                                this.renderHistoryItem(container, trans, item.text, 'Teacher', 'broadcast');
                            }
                        } else {
                            if (item.type === 'broadcast') {
                                this.renderHistoryItem(container, item.text, item.text, 'You', 'broadcast');
                            } else {
                                const trans = await this.translateText(item.text, item.lang, this.state.lang);
                                this.renderHistoryItem(container, trans, item.text, item.senderName, 'question');
                            }
                        }
                    }
                } catch (e) {
                    container.innerHTML = `<p class="text-center text-red-500 text-xs py-10">Error loading history: ${e.message}</p>`;
                }
            }

            renderHistoryItem(container, text, original, sender, type) {
                const div = document.createElement('div');
                const isBroadcast = type === 'broadcast';
                div.className = `p-4 rounded-2xl border ${isBroadcast ? 'bg-white border-gray-100' : 'bg-blue-50/50 border-blue-100'} animate-slide-up`;
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[9px] font-black uppercase tracking-tighter ${isBroadcast ? 'text-gray-400' : 'text-blue-500'}">${sender} â€¢ ${isBroadcast ? 'Broadcast' : 'Question'}</span>
                    </div>
                    <p class="text-sm font-semibold text-gray-800 leading-snug">${text}</p>
                    <p class="text-[10px] text-gray-400 italic mt-1 truncate">${original}</p>
                `;
                container.appendChild(div);
            }

            showToast(msg, type = 'info') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                const colors = { info: 'bg-gray-800 text-white', success: 'bg-green-600 text-white', error: 'bg-red-500 text-white' };
                toast.className = `${colors[type]} px-4 py-2 rounded-lg shadow-xl text-sm font-semibold transform transition-all duration-300 translate-y-[-20px] opacity-0 flex items-center gap-2`;
                toast.innerHTML = type === 'success' ? `<i class="fa-solid fa-check-circle"></i> ${msg}` : msg;
                container.appendChild(toast);
                requestAnimationFrame(() => toast.classList.remove('translate-y-[-20px]', 'opacity-0'));
                setTimeout(() => {
                    toast.classList.add('opacity-0', 'translate-y-[-10px]');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            // --- AUTH ---
            toggleTeacherMode(show) {
                const sForm = document.getElementById('form-student');
                const tForm = document.getElementById('form-teacher');
                const footer = document.getElementById('login-footer');

                if (show) {
                    sForm.classList.add('hidden');
                    footer.classList.add('hidden');
                    tForm.classList.remove('hidden');
                } else {
                    tForm.classList.add('hidden');
                    sForm.classList.remove('hidden');
                    footer.classList.remove('hidden');
                }
            }

            handleLogin() { // Student
                const code = document.getElementById('login-code').value.toUpperCase();
                const name = document.getElementById('login-name').value;
                if (!code || !name) return this.showToast("Please enter room and name", "error");

                this.state = {
                    ...this.state,
                    role: 'student',
                    room: code,
                    name: name,
                    lang: document.getElementById('login-lang').value
                };

                this.requestPermissions();
                this.initStudent();
                this.switchView('view-student');
            }

            handleTeacherLogin() {
                const email = document.getElementById('teacher-email').value;
                const pw = document.getElementById('teacher-pw').value;
                const lang = document.getElementById('teacher-lang').value;

                if (email === "teacher@adahconnect.com" && pw === "teacher456321") {
                    // Generate Room Code
                    const roomCode = "RM" + Math.floor(1000 + Math.random() * 9000);
                    this.state = { ...this.state, role: 'teacher', room: roomCode, name: 'Teacher', lang };

                    this.requestPermissions();
                    document.getElementById('lobby-code').innerText = roomCode;
                    this.switchView('view-lobby');
                    this.showToast("Logged in successfully", "success");
                } else {
                    this.showToast("Invalid Credentials", "error");
                }
            }

            startSession() {
                this.initTeacher();
                this.switchView('view-teacher');
            }

            logout() {
                if (this.state.isMicActive) this.toggleMic();

                // Detach listeners
                if (this.state.room) {
                    const roomRef = ref(this.db, `chats/${this.state.room}`);
                    // Note: In real app use off(), but with modular SDK we just let garbage collection handle or use unsubscribe
                }

                this.clearState();
                this.state.role = null;
                this.state.room = '';
                this.state.name = '';

                // Reset Forms
                this.toggleTeacherMode(false);
                this.switchView('view-login');
            }

            // --- STUDENT LOGIC ---
            initStudent() {
                this.listenForSpeakPermission();
                document.getElementById('student-name-display').innerText = this.state.name;
                document.getElementById('student-room-code').innerText = this.state.room;
                const badge = document.getElementById('student-lang-badge');
                badge.innerText = this.state.lang.toUpperCase();

                const msgsRef = ref(this.db, `chats/${this.state.room}/messages`);
                onChildAdded(msgsRef, async (snap) => {
                    if (this.state.role !== 'student') return;
                    const msg = snap.val();
                    if (!msg) return;

                    // Translate
                    const translated = await this.translateText(msg.text, msg.lang, this.state.lang);

                    // Render
                    this.renderMessageBubble(translated, msg.text, msg.senderName);

                    // TTS Queue - ONLY FOR STUDENTS HEARING TEACHER
                    if (this.state.isTTSActive && msg.senderId !== this.state.name) {
                        this.queueAudio(translated, msg.gender || 'Female');
                    }
                });
            }

            toggleTTS() {
                this.state.isTTSActive = !this.state.isTTSActive;

                // Update Student UI
                const sIcon = document.getElementById('tts-icon');
                const sBtn = document.getElementById('tts-btn');

                // Update Teacher UI
                const tIcon = document.getElementById('teacher-tts-icon');
                const tBtn = document.getElementById('teacher-tts-btn');

                const updateUI = (icon, btn) => {
                    if (!icon || !btn) return;
                    if (this.state.isTTSActive) {
                        icon.className = "fa-solid fa-volume-high";
                        btn.classList.add('text-blue-500');
                    } else {
                        icon.className = "fa-solid fa-volume-xmark";
                        btn.classList.remove('text-blue-500');
                    }
                };

                updateUI(sIcon, sBtn);
                updateUI(tIcon, tBtn);

                if (this.state.isTTSActive) {
                    this.processAudioQueue();
                    this.showToast("Voice Output Enabled", "success");
                } else {
                    this.showToast("Voice Output Muted", "info");
                }
            }

            queueAudio(text, gender) {
                this.state.audioQueue.push({ text, gender });
                if (this.state.isTTSActive) this.processAudioQueue();
            }

            async processAudioQueue() {
                if (this.state.isAudioPlaying || this.state.audioQueue.length === 0) return;

                this.state.isAudioPlaying = true;
                const item = this.state.audioQueue.shift();

                try {
                    const lang = this.state.lang;
                    const baseLang = lang.split('-')[0];
                    const voiceId = CREDENTIALS.CARTESIA_VOICES[lang] ||
                        CREDENTIALS.CARTESIA_VOICES[baseLang] ||
                        CREDENTIALS.CARTESIA_VOICES["default"];

                    // Add emotion tag
                    const transcript = `<emotion value="neutral" />${item.text}`;

                    const res = await fetch("https://api.cartesia.ai/tts/bytes", {
                        method: "POST",
                        headers: {
                            "Cartesia-Version": "2025-04-16",
                            "X-API-Key": CREDENTIALS.CARTESIA,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            "model_id": "sonic-3-latest",
                            "transcript": transcript,
                            "voice": { "mode": "id", "id": voiceId },
                            "output_format": { "container": "wav", "encoding": "pcm_f32le", "sample_rate": 44100 }
                        })
                    });

                    if (res.ok) {
                        const blob = await res.blob();
                        const url = URL.createObjectURL(blob);
                        const audio = new Audio(url);
                        audio.onended = () => {
                            this.state.isAudioPlaying = false;
                            this.processAudioQueue();
                        };
                        audio.onerror = () => {
                            console.error("Audio Playback Error");
                            this.state.isAudioPlaying = false;
                            this.processAudioQueue();
                        };
                        try {
                            await audio.play();
                        } catch (e) {
                            console.error("Autoplay prevented", e);
                            this.state.isAudioPlaying = false;
                            this.processAudioQueue();
                        }
                    } else {
                        console.error("TTS API Error", res.status);
                        this.state.isAudioPlaying = false;
                        this.processAudioQueue();
                    }
                } catch (e) {
                    console.error("TTS Error", e);
                    this.state.isAudioPlaying = false;
                    this.processAudioQueue();
                }
            }

            renderMessageBubble(text, original, sender) {
                const stream = document.getElementById('student-stream');
                const bubble = document.createElement('div');
                bubble.className = "message-bubble bg-white p-4 rounded-2xl rounded-tl-none border border-gray-100 mb-4 animate-slide-up max-w-[90%]";
                bubble.innerHTML = `
                    <p class="text-[10px] text-gray-400 font-bold uppercase mb-1">${sender}</p>
                    <p class="text-lg font-medium text-gray-800 leading-snug">${text}</p>
                    <div class="border-t border-gray-100 mt-2 pt-1">
                        <p class="text-xs text-gray-400 italic truncate">${original}</p>
                    </div>
                `;
                stream.appendChild(bubble);
                stream.scrollTop = stream.scrollHeight;
            }

            // --- TEACHER LOGIC (DEEPGRAM) ---
            initTeacher() {
                // UI Updates
                const codeDisplay = document.getElementById('teacher-code-display');
                if (codeDisplay) codeDisplay.innerText = this.state.room;

                // Questions Listener
                const qRef = ref(this.db, `chats/${this.state.room}/questions`);
                onChildAdded(qRef, async (snap) => {
                    if (this.state.role !== 'teacher') return;
                    const q = snap.val();
                    if (!q) return;

                    const trans = await this.translateText(q.text, q.lang, this.state.lang);
                    this.renderQuestion(trans, q.text, q.senderName);

                    // TEACHER TTS
                    if (this.state.isTTSActive) {
                        this.queueAudio(trans, 'Female');
                    }
                });

                // Speak Queue Listener
                const requestsRef = ref(this.db, `chats/${this.state.room}/speakRequests`);
                import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js").then(db => {
                    db.onValue(requestsRef, (snap) => {
                        this.renderSpeakQueue(snap.val() || {});
                    });
                });

                // Global Config Listener (for Student Mic state)
                const configRef = ref(this.db, `chats/${this.state.room}/config`);
                import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js").then(db => {
                    db.onValue(configRef, (snap) => {
                        const config = snap.val();
                        if (config && config.studentMic !== undefined) {
                            this.state.isStudentMicEnabled = config.studentMic;
                            this.updateStudentMicUI();
                        }
                    });
                });
            }

            requestSpeak() {
                const btn = document.getElementById('student-speak-btn');
                if (btn.classList.contains('text-blue-500')) {
                    this.showToast("Request already sent", "info");
                    return;
                }

                const requestRef = ref(this.db, `chats/${this.state.room}/speakRequests/${this.deviceId}`);
                import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js").then(db => {
                    db.set(requestRef, {
                        name: this.state.name,
                        timestamp: Date.now()
                    });
                    btn.classList.add('text-blue-500', 'animate-pulse');
                    this.showToast("Speak request sent", "success");
                });
            }

            renderSpeakQueue(requests) {
                const list = document.getElementById('teacher-requests');
                const count = document.getElementById('request-count');
                list.innerHTML = '';
                const entries = Object.entries(requests);
                count.innerText = entries.length;

                if (entries.length === 0) {
                    list.innerHTML = '<div class="text-center py-4 opacity-40"><p class="text-[10px]">Empty Queue</p></div>';
                    return;
                }

                entries.sort((a, b) => a[1].timestamp - b[1].timestamp).forEach(([id, data]) => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-2 bg-white rounded-lg border border-gray-100 shadow-sm';
                    div.innerHTML = `
                        <p class="text-xs font-bold text-gray-700">${data.name}</p>
                        <button onclick="App.approveSpeak('${id}')" class="px-2 py-1 bg-green-500 text-white text-[10px] font-black rounded-md hover:bg-green-600">APPROVE</button>
                    `;
                    list.appendChild(div);
                });
            }

            approveSpeak(studentDeviceId) {
                const configRef = ref(this.db, `chats/${this.state.room}/config`);
                import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js").then(db => {
                    db.update(configRef, { currentSpeaker: studentDeviceId });
                    // Remove from queue
                    db.remove(ref(this.db, `chats/${this.state.room}/speakRequests/${studentDeviceId}`));
                    this.showToast("Student authorized", "success");
                });
            }

            listenForSpeakPermission() {
                const configRef = ref(this.db, `chats/${this.state.room}/config`);
                import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js").then(db => {
                    db.onValue(configRef, (snap) => {
                        const config = snap.val() || {};
                        const isMe = config.currentSpeaker === this.deviceId;
                        const btn = document.getElementById('student-speak-btn');

                        if (isMe) {
                            btn.classList.remove('text-blue-500', 'animate-pulse');
                            btn.classList.add('bg-red-500', 'text-white', 'mic-active-ring');
                            this.showToast("You are authorized to speak!", "success");
                            this.startStudentRecording();
                        } else {
                            btn.classList.remove('bg-red-500', 'text-white', 'mic-active-ring');
                            btn.classList.add('text-gray-400');
                        }
                    });
                });
            }

            updateStudentMicUI() {
                const icon = document.getElementById('student-mic-icon');
                const btn = document.getElementById('student-mic-toggle');
                const speakBtn = document.getElementById('btn-speak-mode');

                if (icon && btn) {
                    if (this.state.isStudentMicEnabled) {
                        icon.className = "fa-solid fa-microphone-lines";
                        btn.classList.add('text-green-500');
                    } else {
                        icon.className = "fa-solid fa-microphone-lines-slash";
                        btn.classList.remove('text-green-500');
                    }
                }

                if (speakBtn) speakBtn.disabled = !this.state.isStudentMicEnabled;
            }

            switchQuestionMode(mode) {
                this.toggleModal('question');
                if (mode === 'type') {
                    this.toggleModal('text-input');
                } else {
                    this.startStudentRecording();
                }
            }

            async startStudentRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    });
                    this.mediaRecorder = new MediaRecorder(stream);
                    const chunks = [];

                    this.mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
                    this.mediaRecorder.onstop = async () => {
                        const blob = new Blob(chunks, { type: 'audio/webm' });
                        this.processStudentVoice(blob);
                        stream.getTracks().forEach(t => t.stop());
                    };

                    this.mediaRecorder.start();
                    this.toggleModal('recording');
                    this.startTimer();
                } catch (e) {
                    this.showToast("Microphone access denied", "error");
                }
            }

            stopStudentRecording() {
                if (this.mediaRecorder && this.mediaRecorder.state !== 'inactive') {
                    this.mediaRecorder.stop();
                    this.toggleModal('recording');
                    this.stopTimer();

                    // AUTO-LOCK: Clear current speaker in Firebase
                    import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js").then(db => {
                        db.update(ref(this.db, `chats/${this.state.room}/config`), { currentSpeaker: null });
                    });
                }
            }

            startTimer() {
                let sec = 0;
                this.timerInterval = setInterval(() => {
                    sec++;
                    const m = Math.floor(sec / 60).toString().padStart(2, '0');
                    const s = (sec % 60).toString().padStart(2, '0');
                    document.getElementById('recording-timer').innerText = `${m}:${s}`;
                }, 1000);
            }

            stopTimer() {
                clearInterval(this.timerInterval);
                document.getElementById('recording-timer').innerText = '00:00';
            }

            async processStudentVoice(blob) {
                this.showToast("Transcribing voice...", "info");
                try {
                    const url = `https://api.deepgram.com/v1/listen?smart_format=true&noise_suppression=true&diarize=true&vad_events=true&language=${this.getSTTLang(this.state.lang)}`;
                    const res = await fetch(url, {
                        method: "POST",
                        headers: {
                            "Authorization": "Token " + CREDENTIALS.DEEPGRAM,
                            "Content-Type": "audio/webm"
                        },
                        body: blob
                    });
                    const data = await res.json();
                    const text = data.results.channels[0].alternatives[0].transcript;

                    if (text) {
                        document.getElementById('q-input').value = text;
                        this.sendQuestion();
                    } else {
                        this.showToast("Could not recognize speech", "error");
                    }
                } catch (e) {
                    this.showToast("Transcription failed", "error");
                }
            }

            renderQuestion(text, original, sender) {
                const list = document.getElementById('teacher-questions');
                const card = document.createElement('div');
                card.className = "bg-white border border-blue-100 p-3 rounded-xl shadow-sm animate-slide-up cursor-pointer hover:border-blue-300 transition-colors";
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-[10px] font-bold bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded uppercase">${sender}</span>
                    </div>
                    <p class="text-sm font-semibold text-gray-800 leading-snug">${text}</p>
                    <p class="text-xs text-gray-400 italic mt-1 truncate">${original}</p>
                `;
                list.prepend(card);

                const count = document.getElementById('question-count');
                count.innerText = parseInt(count.innerText) + 1;
            }

            async toggleMic() {
                if (this.state.isMicActive) {
                    // STOP
                    this.stopDeepgram();
                    this.state.isMicActive = false;
                    this.updateMicUI(false);
                } else {
                    // START
                    try {
                        await this.startDeepgram();
                        this.state.isMicActive = true;
                        this.updateMicUI(true);
                        this.showToast("Broadcasting Live", "success");
                    } catch (e) {
                        console.error("Mic Error", e);
                        this.showToast("Microphone Error: " + e.message, "error");
                        this.state.isMicActive = false;
                        this.updateMicUI(false);
                    }
                }
            }

            async startDeepgram() {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });

                // Wake Lock
                if ('wakeLock' in navigator) {
                    try { this.wakeLock = await navigator.wakeLock.request('screen'); } catch (e) { }
                }

                this.dgClient = createClient(CREDENTIALS.DEEPGRAM);
                this.dgSocket = this.dgClient.listen.live({
                    model: "nova-3",
                    language: this.getSTTLang(this.state.lang),
                    smart_format: true,
                    interim_results: true,
                    endpointing: 250,
                    utterance_end_ms: 1000,
                    noise_suppression: true,
                    diarize: true,
                    vad_events: true,
                    keywords: ["classroom", "teacher", "student", "question", "help", "translate", "instruction"]
                });

                this.dgSocket.on(LiveTranscriptionEvents.Open, () => {
                    this.mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                    this.mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0 && this.dgSocket.getReadyState() === 1) {
                            this.dgSocket.send(e.data);
                        }
                    };
                    this.mediaRecorder.start(250);
                });

                this.dgSocket.on(LiveTranscriptionEvents.Transcript, (data) => {
                    const transcript = data.channel.alternatives[0].transcript;
                    if (transcript && data.is_final) {
                        this.broadcastMessage(transcript);
                    }

                    // Live UI Update
                    const ui = document.getElementById('teacher-transcript');
                    if (transcript) ui.innerText = transcript;
                });
            }

            stopDeepgram() {
                if (this.mediaRecorder) this.mediaRecorder.stop();
                if (this.dgSocket) this.dgSocket.finish();
                if (this.wakeLock) this.wakeLock.release();

                this.mediaRecorder = null;
                this.dgSocket = null;
            }

            updateMicUI(active) {
                const btn = document.getElementById('mic-btn');
                const bars = document.querySelectorAll('#mic-status div');

                if (active) {
                    btn.classList.add('bg-red-500', 'text-white', 'mic-active-ring');
                    btn.classList.remove('bg-gray-100', 'text-gray-600');
                    btn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
                    bars.forEach(b => b.classList.add('bg-red-400'));
                } else {
                    btn.classList.remove('bg-red-500', 'text-white', 'mic-active-ring');
                    btn.classList.add('bg-gray-100', 'text-gray-600');
                    btn.innerHTML = '<i class="fa-solid fa-microphone-slash text-sm"></i>';
                    bars.forEach(b => b.classList.remove('bg-red-400'));
                }
            }

            broadcastMessage(text) {
                push(ref(this.db, `chats/${this.state.room}/messages`), {
                    text: text,
                    lang: this.state.lang,
                    senderName: this.state.name,
                    senderId: this.state.name, // Simple ID for now
                    gender: this.state.gender,
                    timestamp: Date.now()
                });
            }

            // --- UTILS ---
            toggleModal(id) {
                const modal = document.getElementById('modal-' + id);
                if (!modal) return;

                const backdrop = modal.querySelector('#modal-backdrop');
                const panel = modal.querySelector('#modal-panel');

                const isHistory = id === 'history';

                if (modal.classList.contains('hidden')) {
                    modal.classList.remove('hidden');
                    if (isHistory) {
                        this.loadHistory();
                        this.backToHistoryList();
                    }
                    requestAnimationFrame(() => {
                        if (backdrop) backdrop.classList.remove('opacity-0');
                        if (panel) panel.classList.remove('translate-y-full');
                    });
                } else {
                    if (backdrop) backdrop.classList.add('opacity-0');
                    if (panel) panel.classList.add('translate-y-full');
                    setTimeout(() => modal.classList.add('hidden'), 300);
                }
            }

            sendQuestion() {
                const val = document.getElementById('q-input').value.trim();
                if (!val) return;

                push(ref(this.db, `chats/${this.state.room}/questions`), {
                    text: val,
                    lang: this.state.lang,
                    senderName: this.state.name,
                    timestamp: Date.now()
                });

                document.getElementById('q-input').value = '';
                this.toggleModal('question');
                this.showToast("Question Sent", "success");
            }

            sendReaction(emoji) {
                this.showToast(`Sent ${emoji}`, "success");
                const float = document.createElement('div');
                float.innerText = emoji;
                float.className = 'fixed bottom-20 left-1/2 text-4xl pointer-events-none animate-bounce z-50';
                float.style.transition = 'all 1s ease-out';
                document.body.appendChild(float);
                setTimeout(() => {
                    float.style.transform = 'translateY(-200px) scale(0)';
                    float.style.opacity = '0';
                    setTimeout(() => float.remove(), 1000);
                }, 50);
            }

            async translateText(text, source, target) {
                if (source === target) return text;
                try {
                    const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=${source}&tl=${target}&dt=t&q=${encodeURI(text)}`);
                    const json = await res.json();
                    return json[0][0][0];
                } catch (e) { return text; }
            }

            copyCode() {
                navigator.clipboard.writeText(this.state.room);
                this.showToast("Copied to clipboard", "success");
            }

            generateId() {
                return 'dev_' + Math.random().toString(36).substr(2, 9);
            }

            saveRoomToHistory(room) {
                if (!room) return;
                const historyRef = ref(this.db, `users/${this.deviceId}/history/${room}`);
                set(historyRef, {
                    lastJoined: Date.now(),
                    roomCode: room
                });
            }

            async loadHistory() {
                const historyRef = ref(this.db, `users/${this.deviceId}/history`);
                const snapshot = await get(historyRef);
                const sessions = snapshot.val() || {};
                const list = document.getElementById('history-sessions');
                list.innerHTML = '';

                Object.values(sessions).sort((a, b) => b.lastJoined - a.lastJoined).forEach(session => {
                    const div = document.createElement('div');
                    div.className = 'group p-4 bg-white border border-gray-100 rounded-2xl hover:border-blue-500 hover:shadow-md cursor-pointer transition-all duration-300';
                    div.onclick = () => {
                        this.loadSession(session.roomCode, session.lastJoined);
                        if (window.innerWidth < 768) {
                            document.getElementById('history-sidebar').classList.add('-translate-x-full');
                        }
                    };
                    div.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-xl bg-blue-50 text-blue-600 flex items-center justify-center group-hover:bg-blue-600 group-hover:text-white transition-colors">
                                    <i class="fa-solid fa-door-open text-sm"></i>
                                </div>
                                <div class="text-left">
                                    <p class="font-black text-gray-900 text-sm">Room: ${session.roomCode}</p>
                                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">${new Date(session.lastJoined).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' })}</p>
                                </div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-gray-300 text-[10px] group-hover:text-blue-500 transform group-hover:translate-x-1 transition-all"></i>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }

            backToHistoryList() {
                const sidebar = document.getElementById('history-sidebar');
                sidebar.classList.remove('-translate-x-full');
            }

            async loadSession(room, timestamp) {
                document.getElementById('history-content-header').classList.remove('hidden');
                document.getElementById('history-room-title').innerText = `Room: ${room}`;
                if (timestamp) {
                    document.getElementById('history-room-date').innerText = new Date(timestamp).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
                }

                const content = document.getElementById('history-content');
                content.innerHTML = '<div class="text-center py-10 animate-pulse text-gray-400">Loading history...</div>';

                const messagesRef = ref(this.db, `rooms/${room}/messages`);
                const snapshot = await get(messagesRef);
                const messages = snapshot.val() || {};
                content.innerHTML = '';

                Object.values(messages).sort((a, b) => a.timestamp - b.timestamp).forEach(msg => {
                    const div = document.createElement('div');
                    div.className = `flex ${msg.role === 'teacher' ? 'justify-start' : 'justify-end'}`;
                    div.innerHTML = `
                        <div class="max-w-[85%] p-4 rounded-2xl text-sm ${msg.role === 'teacher'
                            ? 'bg-white text-gray-800 border border-gray-100 rounded-bl-none shadow-sm'
                            : 'bg-blue-600 text-white rounded-br-none shadow-lg shadow-blue-500/10'
                        }">
                            <div class="flex items-center justify-between mb-1.5 gap-4">
                                <p class="font-black text-[9px] uppercase tracking-widest opacity-50">${msg.senderName}</p>
                                <p class="text-[8px] opacity-40 font-mono">${new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
                            </div>
                            <p class="font-medium leading-relaxed">${msg.text}</p>
                        </div>
                    `;
                    content.appendChild(div);
                });
            }

            getSTTLang(lang) {
                // Priority mappings for dialect/region support
                const mappings = {
                    'nl-NL': 'nl',
                    'nl-BE': 'nl',
                    'tl': 'fil', // Deepgram uses 'fil' for Tagalog/Filipino
                    'uk': 'uk',
                    'fr': 'fr'
                };
                return mappings[lang] || lang.split('-')[0];
            }
        }

        document.addEventListener('DOMContentLoaded', () => new SuccesApp());
    </script>
</body>

</html>
